!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory(global.BMapLib={})}(this,(function(exports){"use strict";var version="1.0.1",T,baidu=T=baidu||{version:"1.5.0"},result,ua;function TileType(){}function TileTypeClass(name,opts){this._name=name,this._baseZoom=18,this._opts={tileSize:256},baidu.extend(this._opts,opts||{})}baidu.guid="$BAIDU$",window[baidu.guid]=window[baidu.guid]||{},baidu.object=baidu.object||{},baidu.extend=baidu.object.extend=function(target,source){for(var p in source)source.hasOwnProperty(p)&&(target[p]=source[p]);return target},baidu.dom=baidu.dom||{},baidu.dom.g=function(id){return"string"==typeof id||id instanceof String?document.getElementById(id):id&&id.nodeName&&(1==id.nodeType||9==id.nodeType)?id:null},baidu.g=baidu.G=baidu.dom.g,baidu.dom.hide=function(element){return(element=baidu.dom.g(element)).style.display="none",element},baidu.hide=baidu.dom.hide,baidu.lang=baidu.lang||{},baidu.lang.isString=function(source){return"[object String]"==Object.prototype.toString.call(source)},baidu.isString=baidu.lang.isString,baidu.dom._g=function(id){return baidu.lang.isString(id)?document.getElementById(id):id},baidu._g=baidu.dom._g,baidu.dom.contains=function(container,contained){var g=baidu.dom._g;return container=g(container),contained=g(contained),container.contains?container!=contained&&container.contains(contained):!!(16&container.compareDocumentPosition(contained))},baidu.browser=baidu.browser||{},baidu.dom._NAME_ATTRS=result={cellpadding:"cellPadding",cellspacing:"cellSpacing",colspan:"colSpan",rowspan:"rowSpan",valign:"vAlign",usemap:"useMap",frameborder:"frameBorder",htmlFor:"for",className:"class"},baidu.dom.setAttr=function(element,key,value){return element=baidu.dom.g(element),"style"==key?element.style.cssText=value:(key=baidu.dom._NAME_ATTRS[key]||key,element.setAttribute(key,value)),element},baidu.setAttr=baidu.dom.setAttr,baidu.dom.setAttrs=function(element,attributes){for(var key in element=baidu.dom.g(element),attributes)baidu.dom.setAttr(element,key,attributes[key]);return element},baidu.setAttrs=baidu.dom.setAttrs,baidu.string=baidu.string||{},baidu.dom.removeClass=function(element,className){for(var oldClasses=(element=baidu.dom.g(element)).className.split(/\s+/),newClasses=className.split(/\s+/),lenOld,lenDel=newClasses.length,j,i=0;i<lenDel;++i)for(j=0,lenOld=oldClasses.length;j<lenOld;++j)if(oldClasses[j]==newClasses[i]){oldClasses.splice(j,1);break}return element.className=oldClasses.join(" "),element},baidu.rc=baidu.removeClass=baidu.dom.removeClass,baidu.dom.insertHTML=function(element,position,html){var range,begin;return(element=baidu.dom.g(element)).insertAdjacentHTML?element.insertAdjacentHTML(position,html):(range=element.ownerDocument.createRange(),"AFTERBEGIN"==(position=position.toUpperCase())||"BEFOREEND"==position?(range.selectNodeContents(element),range.collapse("AFTERBEGIN"==position)):(range[(begin="BEFOREBEGIN"==position)?"setStartBefore":"setEndAfter"](element),range.collapse(begin)),range.insertNode(range.createContextualFragment(html))),element},baidu.insertHTML=baidu.dom.insertHTML,baidu.dom.show=function(element){return(element=baidu.dom.g(element)).style.display="",element},baidu.show=baidu.dom.show,baidu.dom.getDocument=function(element){return 9==(element=baidu.dom.g(element)).nodeType?element:element.ownerDocument||element.document},baidu.dom.addClass=function(element,className){element=baidu.dom.g(element);for(var classArray=className.split(/\s+/),result=element.className,classMatch=" "+result+" ",i=0,l=classArray.length;i<l;i++)classMatch.indexOf(" "+classArray[i]+" ")<0&&(result+=" "+classArray[i]);return element.className=result,element},baidu.ac=baidu.addClass=baidu.dom.addClass,baidu.dom._styleFixer=baidu.dom._styleFixer||{},baidu.dom._styleFilter=baidu.dom._styleFilter||[],baidu.dom._styleFilter.filter=function(key,value,method){for(var i=0,filters=baidu.dom._styleFilter,filter;filter=filters[i];i++)(filter=filter[method])&&(value=filter(key,value));return value},baidu.string.toCamelCase=function(source){return source.indexOf("-")<0&&source.indexOf("_")<0?source:source.replace(/[-_][^-_]/g,(function(match){return match.charAt(1).toUpperCase()}))},baidu.dom.getStyle=function(element,key){var dom=baidu.dom;element=dom.g(element),key=baidu.string.toCamelCase(key);var value=element.style[key];if(!value){var fixer=dom._styleFixer[key],style=element.currentStyle||getComputedStyle(element,null);value=fixer&&fixer.get?fixer.get(element,style):style[fixer||key]}return(fixer=dom._styleFilter)&&(value=fixer.filter(key,value,"get")),value},baidu.getStyle=baidu.dom.getStyle,/opera\/(\d+\.\d)/i.test(navigator.userAgent)&&(baidu.browser.opera=+RegExp.$1),baidu.browser.isWebkit=/webkit/i.test(navigator.userAgent),baidu.browser.isGecko=/gecko/i.test(navigator.userAgent)&&!/like gecko/i.test(navigator.userAgent),baidu.browser.isStrict="CSS1Compat"==document.compatMode,baidu.dom.getPosition=function(element){element=baidu.dom.g(element);var doc=baidu.dom.getDocument(element),browser=baidu.browser,getStyle=baidu.dom.getStyle,BUGGY_GECKO_BOX_OBJECT=browser.isGecko>0&&doc.getBoxObjectFor&&"absolute"==getStyle(element,"position")&&(""===element.style.top||""===element.style.left),pos={left:0,top:0},viewport,parent,box;if(element==(browser.ie&&!browser.isStrict?doc.body:doc.documentElement))return pos;if(element.getBoundingClientRect){box=element.getBoundingClientRect(),pos.left=Math.floor(box.left)+Math.max(doc.documentElement.scrollLeft,doc.body.scrollLeft),pos.top=Math.floor(box.top)+Math.max(doc.documentElement.scrollTop,doc.body.scrollTop),pos.left-=doc.documentElement.clientLeft,pos.top-=doc.documentElement.clientTop;var htmlDom=doc.body,htmlBorderLeftWidth=parseInt(getStyle(htmlDom,"borderLeftWidth")),htmlBorderTopWidth=parseInt(getStyle(htmlDom,"borderTopWidth"));browser.ie&&!browser.isStrict&&(pos.left-=isNaN(htmlBorderLeftWidth)?2:htmlBorderLeftWidth,pos.top-=isNaN(htmlBorderTopWidth)?2:htmlBorderTopWidth)}else{parent=element;do{if(pos.left+=parent.offsetLeft,pos.top+=parent.offsetTop,browser.isWebkit>0&&"fixed"==getStyle(parent,"position")){pos.left+=doc.body.scrollLeft,pos.top+=doc.body.scrollTop;break}parent=parent.offsetParent}while(parent&&parent!=element);for((browser.opera>0||browser.isWebkit>0&&"absolute"==getStyle(element,"position"))&&(pos.top-=doc.body.offsetTop),parent=element.offsetParent;parent&&parent!=doc.body;)pos.left-=parent.scrollLeft,browser.opera&&"TR"==parent.tagName||(pos.top-=parent.scrollTop),parent=parent.offsetParent}return pos},/firefox\/(\d+\.\d)/i.test(navigator.userAgent)&&(baidu.browser.firefox=+RegExp.$1),ua=navigator.userAgent,/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(ua)&&!/chrome/i.test(ua)&&(baidu.browser.safari=+(RegExp.$1||RegExp.$2)),/chrome\/(\d+\.\d)/i.test(navigator.userAgent)&&(baidu.browser.chrome=+RegExp.$1),baidu.array=baidu.array||{},baidu.array.each=function(source,iterator){var returnValue,item,i,len=source.length;if("function"==typeof iterator)for(i=0;i<len&&(item=source[i],!1!==(returnValue=iterator.call(source,item,i)));i++);return source},baidu.each=baidu.array.each,baidu.lang.guid=function(){return"TANGRAM__"+(window[baidu.guid]._counter++).toString(36)},window[baidu.guid]._counter=window[baidu.guid]._counter||1,window[baidu.guid]._instances=window[baidu.guid]._instances||{},baidu.lang.isFunction=function(source){return"[object Function]"==Object.prototype.toString.call(source)},baidu.lang.isNumber=function(source){return"[object Number]"==Object.prototype.toString.call(source)},baidu.lang.Class=function(guid){this.guid=guid||baidu.lang.guid(),window[baidu.guid]._instances[this.guid]=this},window[baidu.guid]._instances=window[baidu.guid]._instances||{},baidu.lang.Class.prototype.dispose=function(){for(var property in delete window[baidu.guid]._instances[this.guid],this)baidu.lang.isFunction(this[property])||delete this[property];this.disposed=!0},baidu.lang.Class.prototype.toString=function(){return"[object "+(this._className||"Object")+"]"},baidu.lang.Event=function(type,target){this.type=type,this.returnValue=!0,this.target=target||null,this.currentTarget=null},baidu.lang.Class.prototype.addEventListener=function(type,handler,key){if(baidu.lang.isFunction(handler)){!this.__listeners&&(this.__listeners={});var t=this.__listeners,id;if("string"==typeof key&&key){if(/[^\w\-]/.test(key))throw"nonstandard key:"+key;handler.hashCode=key,id=key}0!=type.indexOf("on")&&(type="on"+type),"object"!=typeof t[type]&&(t[type]={}),id=id||baidu.lang.guid(),handler.hashCode=id,t[type][id]=handler}},baidu.lang.Class.prototype.removeEventListener=function(type,handler){if(baidu.lang.isFunction(handler))handler=handler.hashCode;else if(!baidu.lang.isString(handler))return;!this.__listeners&&(this.__listeners={}),0!=type.indexOf("on")&&(type="on"+type);var t=this.__listeners;t[type]&&t[type][handler]&&delete t[type][handler]},baidu.lang.Class.prototype.dispatchEvent=function(event,options){for(var i in baidu.lang.isString(event)&&(event=new baidu.lang.Event(event)),!this.__listeners&&(this.__listeners={}),options=options||{})event[i]=options[i];var i,t=this.__listeners,p=event.type;if(event.target=event.target||this,event.currentTarget=this,0!=p.indexOf("on")&&(p="on"+p),baidu.lang.isFunction(this[p])&&this[p].apply(this,arguments),"object"==typeof t[p])for(i in t[p])t[p][i].apply(this,arguments);return event.returnValue},baidu.lang.inherits=function(subClass,superClass,className){var key,proto,selfProps=subClass.prototype,clazz=new Function;for(key in clazz.prototype=superClass.prototype,proto=subClass.prototype=new clazz,selfProps)proto[key]=selfProps[key];subClass.prototype.constructor=subClass,subClass.superClass=superClass.prototype,"string"==typeof className&&(proto._className=className)},baidu.inherits=baidu.lang.inherits,baidu.lang.instance=function(guid){return window[baidu.guid]._instances[guid]||null},baidu.isMobile=/Mobile/i.test(navigator.userAgent),baidu.platform=baidu.platform||{},baidu.platform.isAndroid=/android/i.test(navigator.userAgent),/android (\d+\.\d)/i.test(navigator.userAgent)&&(baidu.platform.android=baidu.android=RegExp.$1),baidu.platform.isIpad=/ipad/i.test(navigator.userAgent),baidu.platform.isIphone=/iphone/i.test(navigator.userAgent),baidu.platform.iosVersion=/iphone os (\d)\_/i.test(navigator.userAgent)?+RegExp.$1:0,baidu.lang.Event.prototype.inherit=function(e){var me=this;if(this.domEvent=e=window.event||e,me.clientX=e.clientX||e.pageX,me.clientY=e.clientY||e.pageY,me.offsetX=e.offsetX||e.layerX,me.offsetY=e.offsetY||e.layerY,me.screenX=e.screenX,me.screenY=e.screenY,me.ctrlKey=e.ctrlKey||e.metaKey,me.shiftKey=e.shiftKey,me.altKey=e.altKey,e.touches){me.touches=[];for(var i=0;i<e.touches.length;i++)me.touches.push({clientX:e.touches[i].clientX,clientY:e.touches[i].clientY,screenX:e.touches[i].screenX,screenY:e.touches[i].screenY,pageX:e.touches[i].pageX,pageY:e.touches[i].pageY,target:e.touches[i].target,identifier:e.touches[i].identifier})}if(e.changedTouches){me.changedTouches=[];for(var i=0;i<e.changedTouches.length;i++)me.changedTouches.push({clientX:e.changedTouches[i].clientX,clientY:e.changedTouches[i].clientY,screenX:e.changedTouches[i].screenX,screenY:e.changedTouches[i].screenY,pageX:e.changedTouches[i].pageX,pageY:e.changedTouches[i].pageY,target:e.changedTouches[i].target,identifier:e.changedTouches[i].identifier})}if(e.targetTouches){me.targetTouches=[];for(var i=0;i<e.targetTouches.length;i++)me.targetTouches.push({clientX:e.targetTouches[i].clientX,clientY:e.targetTouches[i].clientY,screenX:e.targetTouches[i].screenX,screenY:e.targetTouches[i].screenY,pageX:e.targetTouches[i].pageX,pageY:e.targetTouches[i].pageY,target:e.targetTouches[i].target,identifier:e.targetTouches[i].identifier})}return me.rotation=e.rotation,me.scale=e.scale,me},baidu.lang.decontrol=function(guid){var m=window[baidu.guid];m._instances&&delete m._instances[guid]},baidu.event={},baidu.on=baidu.event.on=function(el,type,handler){return(el=baidu.g(el))?(type=type.replace(/^on/,""),el.addEventListener?el.addEventListener(type,handler,!1):el.attachEvent&&el.attachEvent("on"+type,handler),el):el},baidu.un=baidu.event.un=function(el,type,handler){return(el=baidu.g(el))?(type=type.replace(/^on/,""),el.removeEventListener?el.removeEventListener(type,handler,!1):el.detachEvent&&el.detachEvent("on"+type,handler),el):el},baidu.dom.hasClass=function(el,className){if(!el||!el.className||"string"!=typeof el.className)return!1;var res=-1;try{res=el.className==className||el.className.indexOf(className)}catch(e){return!1}return res>-1},T.undope=!0,TileType.instances={},TileType.getInstance=function(tileTypeName,opts){if(TileType.instances[tileTypeName])return TileType.instances[tileTypeName];var newTileType=new TileTypeClass(tileTypeName,opts);return TileType.instances[tileTypeName]=newTileType,newTileType},TileTypeClass.mapZoomBaseIndex=[0,0,0,8,7,7,6,6,5,5,4,3,3,3,2,2,1,1,0,0,0,0],TileTypeClass.baseScaleZoom=[19,17,15,12,10,9,7,5,3],TileTypeClass.baseScaleZoomMercatorSize=[512,2048,4096,32768,65536,262144,1048576,4194304,8388608],TileTypeClass.mapZoomBaseZoomMapping=[0,0,0,3,5,5,7,7,9,9,10,12,12,12,15,15,17,17,19,19,19,19],TileTypeClass.baseScaleTileSize=[1024,1024,512,512,256,512,512,512,256],TileTypeClass.mapZoomTileSize=[0,0,0,256,256,512,256,512,256,512,256,256,512,1024,256,512,512,1024,512,1024,2048,4096],TileTypeClass.baseZoomInfo={3:[3],5:[4,5],7:[6,7],9:[8,9],10:[10],12:[11,12,13],15:[14,15],17:[16,17],19:[18,19,20,21]},TileTypeClass.prototype={getTileSize:function(mapZoom){return mapZoom=Math.floor(mapZoom),"na"===this._name?TileTypeClass.mapZoomTileSize[mapZoom]:this._opts.tileSize},getDataZoom:function(mapZoom){return mapZoom=Math.floor(mapZoom),"na"===this._name?TileTypeClass.mapZoomBaseZoomMapping[mapZoom]:mapZoom},getMercatorSize:function(mapZoom,dataZoom){if("na"===this._name){mapZoom=Math.floor(mapZoom);var index=TileTypeClass.mapZoomBaseIndex[mapZoom];return TileTypeClass.baseScaleZoomMercatorSize[index]}return this._opts.tileSize*this.getZoomUnits(this.getDataZoom(mapZoom))}};var XPI=52.35987755982988,MCBAND=[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND=[75,60,45,30,15,0],MC2LL=[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC=[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],ApiUtil={setPosition:function(obj,position){var s=obj.style;s.left=position[0]+"px",s.top=position[1]+"px"},setUnSelectable:function(obj){obj.style.MozUserSelect="none"},isInDocument:function(obj){return obj&&obj.parentNode&&11!=obj.parentNode.nodeType},beforeEndHTML:function(parent,chlidHTML){return baidu.dom.insertHTML(parent,"beforeEnd",chlidHTML),parent.lastChild},getPosition:function(element){for(var pos={left:0,top:0};element&&element.offsetParent;)pos.left+=element.offsetLeft,pos.top+=element.offsetTop,element=element.offsetParent;return pos},stopBubble:function(e){var e;(e=window.event||e).stopPropagation?e.stopPropagation():e.cancelBubble=!0},preventDefault:function(e){var e;return(e=window.event||e).preventDefault?e.preventDefault():e.returnValue=!1,!1},stopAndPrevent:function(e){return this.stopBubble(e),this.preventDefault(e)},getScroll:function(){var dd=document.documentElement,db=document.body;return dd&&(dd.scrollTop||dd.scrollLeft)?[dd.scrollTop,dd.scrollLeft]:db?[db.scrollTop,db.scrollLeft]:[0,0]},getDistanceByPixel:function(px1,px2){if(px1&&px2)return Math.round(Math.sqrt(Math.pow(px1.x-px2.x,2)+Math.pow(px1.y-px2.y,2)))},create:function(tag,attr,ns){var e=document.createElement(tag);return ns&&(e=document.createElementNS(ns,tag)),baidu.dom.setAttrs(e,attr||{})},getCurrentStyle:function(el){return el.currentStyle?el.currentStyle:el.ownerDocument&&el.ownerDocument.defaultView?el.ownerDocument.defaultView.getComputedStyle(el,null):void 0},isDefined:function(object){return void 0!==object},isSupportSvg:function(){return"boolean"!=typeof this.isSupportSvg.result&&(this.isSupportSvg.result=!!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Shape","1.1")),this.isSupportSvg.result},isSupportCanvas:function(){return"boolean"!=typeof this.isSupportCanvas.result&&(this.isSupportCanvas.result=!!this.create("canvas").getContext),this.isSupportCanvas.result},toRadian:function(angle){return angle*Math.PI/180},toAngle:function(radian){return radian/Math.PI*180},isMobile:function(){return!!(baidu.platform.isIphone||baidu.platform.isIpad||baidu.platform.isAndroid)},getCurrentTime:function(){return(new Date).getTime()},isAndroid23More:function(){return!!(baidu.platform.isAndroid&&parseFloat(baidu.platform.android)>2.3)},cohenSutherlandLineClip:function(pixel0,pixel1,pixelBounds){var accept=!1,clip=!1,done=!1,px0={x:pixel0.x,y:pixel0.y},px1={x:pixel1.x,y:pixel1.y},outcode0=this.calcOutcode(px0,pixelBounds),outcode1=this.calcOutcode(px1,pixelBounds),outcodeOut,x,y,minX=pixelBounds.minX,minY=pixelBounds.minY,maxX=pixelBounds.maxX,maxY=pixelBounds.maxY;do{0==outcode0.all&&0==outcode1.all?(accept=!0,done=!0):0!=(outcode0.all&outcode1.all)?done=!0:((outcodeOut=0!=outcode0.all?outcode0:outcode1).top?(x=px0.x+(px1.x-px0.x)*(minY-px0.y)/(px1.y-px0.y),y=minY):outcodeOut.bottom?(x=px0.x+(px1.x-px0.x)*(maxY-px0.y)/(px1.y-px0.y),y=maxY):outcodeOut.right?(y=px0.y+(px1.y-px0.y)*(maxX-px0.x)/(px1.x-px0.x),x=maxX):outcodeOut.left&&(y=px0.y+(px1.y-px0.y)*(minX-px0.x)/(px1.x-px0.x),x=minX),clip=!0,outcodeOut.all==outcode0.all?(px0.x=Math.round(x),px0.y=Math.round(y),outcode0=this.calcOutcode(px0,pixelBounds)):(px1.x=Math.round(x),px1.y=Math.round(y),outcode1=this.calcOutcode(px1,pixelBounds)))}while(!done);if(accept)return{pixel0:new Pixel(px0.x,px0.y),pixel1:new Pixel(px1.x,px1.y),clip:!!clip}},calcOutcode:function(pixel,pixelBounds){var code={top:0,bottom:0,right:0,left:0,all:0},x=pixel.x,y=pixel.y;return y<pixelBounds.minY?(code.top=8,code.all+=code.top):y>pixelBounds.maxY&&(code.bottom=4,code.all+=code.bottom),x>pixelBounds.maxX?(code.right=2,code.all+=code.right):x<pixelBounds.minX&&(code.left=1,code.all+=code.left),code},douglasPeucker:function(points,epsilon){if(0==epsilon)return points;for(var dmax=0,index=0,i=1,l=points.length-1;i<l;i++){var d=this.getDistance(points[i],points[0],points[points.length-1]);d>dmax&&(index=i,dmax=d)}var ResultList=[];if(dmax>=epsilon){for(var points1=points.slice(0,index),points2=points.slice(index,points.length),recResults1=this.douglasPeucker(points1,epsilon),recResults2=this.douglasPeucker(points2,epsilon),i=0,l=recResults1.length;i<l;i++)ResultList.push(recResults1[i]);for(var i=0,l=recResults2.length;i<l;i++)ResultList.push(recResults2[i])}else ResultList.push(points[0]),ResultList.push(points[points.length-1]);return ResultList},pointInPolygon:function(point,polygonPoints){for(var x=point[0],y=point[1],inside=!1,i=0,j=polygonPoints.length-2;i<polygonPoints.length;i+=2){var xi=polygonPoints[i],yi=polygonPoints[i+1],xj=polygonPoints[j],yj=polygonPoints[j+1],intersect;yi>y!=yj>y&&x<(xj-xi)*(y-yi)/(yj-yi)+xi&&(inside=!inside),j=i}return inside},getDistance:function(point,startPoint,endPoint){var disX=startPoint.lng-endPoint.lng,disY=startPoint.lat-endPoint.lat;if(0==disX)return Math.abs(point.lng-startPoint.lng);if(0==disY)return Math.abs(point.lat-startPoint.lat);var k=disY/disX,b=startPoint.lat-k*startPoint.lng;return Math.abs(k*point.lng-point.lat+b)/Math.sqrt(k*k+1)},encodeTileUrl:function(str){for(var originHexStr="",i=0;i<str.length;i++){var charCode,hex=(charCode=str.charCodeAt(i)<<1).toString(2),len,formatHex=hex;hex.length<8&&(formatHex=(formatHex="00000000"+hex).substr(hex.length,8)),originHexStr+=formatHex}for(var add=5-originHexStr.length%5,arr=[],i=0;i<add;i++)arr[i]="0";originHexStr=arr.join("")+originHexStr;for(var result=[],i=0;i<originHexStr.length/5;i++){var charCode=originHexStr.substr(5*i,5),finalCharCode=parseInt(charCode,2)+50;result.push(String.fromCharCode(finalCharCode))}return result.join("")+add.toString()},pixelToLngLat:function(x,y,zoom){return this.convertMC2LL([x/Math.pow(2,zoom-18),y/Math.pow(2,zoom-18)])},lngLatToPixel:function(lng,lat,zoom){var mercator=this.convertLL2MC([lng,lat]),x=mercator[0]*Math.pow(2,zoom-18),y=mercator[1]*Math.pow(2,zoom-18);return[Math.ceil(x),Math.ceil(y)]},pointToLngLat:function(x,y){return this.convertMC2LL([x,y])},lngLatToPoint:function(lng,lat){return this.convertLL2MC([lng,lat])},translatePoint:function(opt){var me=this,defaultOpt={points:[],from:0,to:0},opts=$.extend(!0,{},defaultOpt,opt),points=[];return 6===opts.from&&5===opts.to?$.each(opts.points,(function(k,v){points.push(me.pointToLngLat(v[0],v[1]))})):$.each(opts.points,(function(k,v){points.push(me.lngLatToPoint(v[0],v[1]))})),points},pointsStrToLngLatArr:function(pointStr){var me=this,points=[],pointsTmp=pointStr.split(",");return $.trim(pointsTmp[0])===$.trim(pointsTmp[pointsTmp.length-1])&&pointsTmp.pop(),$.each(pointsTmp,(function(k,v){var pointTmp=$.trim(v).split(" "),tmp=me.pointToLngLat(pointTmp[0],pointTmp[1]);points.push(new BMap.Point(tmp[0],tmp[1]))})),points},convertLL2MC:function(point){var temp,factor;point[0]=this.getLoop(point[0],-180,180),point[1]=this.getRange(point[1],-74,74),temp=point.slice(0);for(var i=0;i<LLBAND.length;i++)if(temp[1]>=LLBAND[i]){factor=LL2MC[i];break}if(!factor)for(var i=LLBAND.length-1;i>=0;i--)if(temp[1]<=-LLBAND[i]){factor=LL2MC[i];break}var mc=this.convertor(point,factor),point;return point=[parseFloat(mc[0].toFixed(2)),parseFloat(mc[1].toFixed(2))]},convertMC2LL:function(point){var temp,factor;temp=[Math.abs(point[0]),Math.abs(point[1])];for(var i=0;i<MCBAND.length;i++)if(temp[1]>=MCBAND[i]){factor=MC2LL[i];break}var lnglat=this.convertor(point,factor),point;return point=[parseFloat(lnglat[0].toFixed(12)),parseFloat(lnglat[1].toFixed(12))]},convertor:function(fromPoint,factor){if(fromPoint&&factor){var x=factor[0]+factor[1]*Math.abs(fromPoint[0]),temp=Math.abs(fromPoint[1])/factor[9],y=factor[2]+factor[3]*temp+factor[4]*temp*temp+factor[5]*temp*temp*temp+factor[6]*temp*temp*temp*temp+factor[7]*temp*temp*temp*temp*temp+factor[8]*temp*temp*temp*temp*temp*temp;return[x*=fromPoint[0]<0?-1:1,y*=fromPoint[1]<0?-1:1]}},getRange:function(v,a,b){return null!=a&&(v=Math.max(v,a)),null!=b&&(v=Math.min(v,b)),v},getLoop:function(v,a,b){for(;v>b;)v-=b-a;for(;v<a;)v+=b-a;return v},convertGCJ02ToBD09:function(point){var newPoint={lng:0,lat:0},x=point.lng,y=point.lat,z=Math.sqrt(x*x+y*y)+2e-5*Math.sin(y*XPI),theta=Math.atan2(y,x)+3e-6*Math.cos(x*XPI);return newPoint.lng=Math.round(1e6*(z*Math.cos(theta)+.0065))/1e6,newPoint.lat=Math.round(1e6*(z*Math.sin(theta)+.006))/1e6,newPoint},convertBD09ToGCJ02:function(point){var newPoint={lng:0,lat:0},x=point.lng-.0065,y=point.lat-.006,z=Math.sqrt(x*x+y*y)-2e-5*Math.sin(y*XPI),theta=Math.atan2(y,x)-3e-6*Math.cos(x*XPI);return newPoint.lng=Math.round(z*Math.cos(theta)*1e6)/1e6,newPoint.lat=Math.round(z*Math.sin(theta)*1e6)/1e6,newPoint}},requestOpts={loadedCbk:function(e){},errorCbk:function(e){}},DataRequest_request=function(url,opts){opts=opts||{},baidu.extend(requestOpts,opts);var script=ApiUtil.create("script",{src:url,type:"text/javascript",charset:"utf-8"});script.addEventListener?(script.addEventListener("load",(function(e){var t=e.target;t.parentNode.removeChild(t)}),!1),script.addEventListener("loaded",(function(e){requestOpts.loadedCbk&&requestOpts.loadedCbk([,,,,,])}),!1),script.addEventListener("error",(function(e){requestOpts.errorCbk&&requestOpts.errorCbk([,,,,,])}),!1)):script.attachEvent&&script.attachEvent("onreadystatechange",(function(e){var t=window.event.srcElement;!t||"loaded"!=t.readyState&&"complete"!=t.readyState||t.parentNode.removeChild(t)})),document.getElementsByTagName("head")[0].appendChild(script),script=null},MapConfig={imgPath:"//webmap0.bdimg.com/image/api/",tileUrls:{http:["https://ss0.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/pvd/?qt=vtile","https://ss1.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/pvd/?qt=vtile"],https:["https://ss0.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/pvd/?qt=vtile","https://ss1.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/pvd/?qt=vtile","https://ss2.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/pvd/?qt=vtile","https://ss3.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/pvd/?qt=vtile"]},vctMapStyleDomain:"https://ss0.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/sty/",iconUrls:["https://ss0.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/sty/map_icons2x/","https://ss1.bdstatic.com/8bo_dTSlR1gBo1vgoIiO_jowehsv/sty/map_icons2x/"],poiUrl:"https://api.map.baidu.com/?qt=inf&operate=mapclick&clicktype=tile&ie=utf-8&oue=1&fromproduct=jsapi&res=api"};baidu.browser.ie?baidu.extend(MapConfig,{distCursor:"url("+MapConfig.imgPath+"ruler.cur),crosshair",defaultCursor:"url("+MapConfig.imgPath+"openhand.cur),default",draggingCursor:"url("+MapConfig.imgPath+"closedhand.cur),move"}):baidu.browser.firefox?baidu.extend(MapConfig,{distCursor:"url("+MapConfig.imgPath+"ruler.cur),crosshair",defaultCursor:"-moz-grab",draggingCursor:"-moz-grabbing"}):baidu.browser.chrome||baidu.browser.safari?(baidu.extend(MapConfig,{distCursor:"url("+MapConfig.imgPath+"ruler.cur) 2 6,crosshair",defaultCursor:"url("+MapConfig.imgPath+"openhand.cur) 8 8,default",draggingCursor:"url("+MapConfig.imgPath+"closedhand.cur) 8 8,move"}),(baidu.platform.isIphone||baidu.platform.isIpad)&&(MapConfig.defaultCursor="-webkit-grab",MapConfig.draggingCursor="-webkit-grabbing")):baidu.extend(MapConfig,{distCursor:"url("+MapConfig.imgPath+"ruler.cur),crosshair",defaultCursor:"url("+MapConfig.imgPath+"openhand.cur),default",draggingCursor:"url("+MapConfig.imgPath+"closedhand.cur),move"});var BaseEvent=baidu.lang.Event,FLOOR_BTN_HEIGHT=26,SWITCH_ARROW_HEIGHT=15;function IndoorControl(map,indoorMgr,indoorInfo){this._map=map,this.container=map.getContainer(),this._indoorMgr=indoorMgr,this._indoorInfo=indoorInfo,this._visible=!0,this._adjustVisible=!0,this._bottomOffset=0,this._init()}IndoorControl.prototype={_init:function(){this._render(),this._bindDom(),this._bind(),this._adjustDisplayHeight()},_render:function(){if(this._indoorInfo){var div=this._div=ApiUtil.create("div");baidu.ac(div,"floor-select-container"),baidu.ac(div,"all-border-radius");var btnTop=this._btnTop=ApiUtil.create("button");baidu.ac(btnTop,"floor-switch-top"),baidu.ac(btnTop,"top-border-radius");var btnTopIcon=ApiUtil.create("div");baidu.ac(btnTopIcon,"floor-switch-top-icon"),btnTop.appendChild(btnTopIcon);var btnBottom=this._btnBottom=ApiUtil.create("button"),btnBottomIcon=ApiUtil.create("div");baidu.ac(btnBottomIcon,"floor-switch-bottom-icon"),btnBottom.appendChild(btnBottomIcon),baidu.ac(btnBottom,"floor-switch-bottom"),baidu.ac(btnBottom,"bottom-border-radius");var floorsContainer=this._floorsContainer=ApiUtil.create("div");baidu.ac(floorsContainer,"floors-container"),floorsContainer.appendChild(this._createFloorsDom()),this._div.appendChild(btnTop),this._div.appendChild(floorsContainer),this._div.appendChild(btnBottom);var switchButtonHeight=0;""===this._btnTop.style.display&&(switchButtonHeight=30),this._div.style.height=parseInt(this._floorsContainer.style.height,10)+switchButtonHeight+"px",this._div.style.top="20px",this.container.appendChild(this._div);var me=this;setTimeout((function(){me._div.style.right="20px"}),20)}},_createFloorsDom:function(){if(this._indoorInfo){for(var ol=this._ol=ApiUtil.create("ol"),currentFloor=this._indoorInfo.currentFloor,i=this._indoorInfo.floors.length-1;i>=0;i--){var eachFloorName=this._indoorInfo.floors[i],li=ApiUtil.create("li"),button=ApiUtil.create("button");baidu.ac(button,"btn-select-floor"),eachFloorName===currentFloor&&baidu.ac(button,"selected"),button.setAttribute("data-floor",eachFloorName),button.innerHTML=eachFloorName,li.appendChild(button),ol.appendChild(li)}return ol}},updateUI:function(){if(!this._ol)return this._render(),this._bind(),void this._adjustDisplayHeight();this._ol=null,this._ol=this._createFloorsDom(),this._floorsContainer.innerHTML="",this._floorsContainer.appendChild(this._ol),this._adjustDisplayHeight()},_bind:function(){var map=this._map,me=this;map.addEventListener("indoor_status_changed",(function(e){if(!1!==me._visible){var ol=me._ol,uid;if(e.uid)for(var floor=e.floor,i=0;i<ol.children.length;i++){var button=ol.children[i].children[0];button.getAttribute("data-floor")===floor?baidu.ac(button,"selected"):baidu.rc(button,"selected")}}})),map.addEventListener("zoomend",(function(e){!me._indoorMgr.config.enableIndoor||this.getZoom()<me._indoorMgr.config.minZoom?me._setAdjustVisbile(!1):me._setAdjustVisbile(!0)}))},_bindDom:function(){var me=this;baidu.on(this._floorsContainer,"click",(function(e){var target=e.target||e.srcElement;if("button"===target.tagName.toLowerCase()){me._indoorMgr.showIndoor(me._indoorInfo.uid,target.getAttribute("data-floor"));var event=new BaseEvent("onindoor_bar_click");event.uid=me._indoorInfo.uid,me._map.dispatchEvent(event)}})),baidu.on(this._floorsContainer,"mouseover",(function(e){var target=e.target;"button"===target.tagName.toLowerCase()&&baidu.ac(target,"hover")})),baidu.on(this._floorsContainer,"mouseout",(function(e){var target=e.target;"button"===target.tagName.toLowerCase()&&baidu.rc(target,"hover")})),baidu.on(this._btnTop,"mouseover",(function(e){this._disable||baidu.ac(this,"hover")})),baidu.on(this._btnTop,"mouseout",(function(e){baidu.rc(this,"hover")})),baidu.on(this._btnBottom,"mouseover",(function(e){this._disable||baidu.ac(this,"hover")})),baidu.on(this._btnBottom,"mouseout",(function(e){baidu.rc(this,"hover")})),baidu.on(this._btnTop,"click",(function(e){me._setBarSliderTop(parseInt(me._ol.style.top,10)+26)})),baidu.on(this._btnBottom,"click",(function(e){me._setBarSliderTop(parseInt(me._ol.style.top,10)-26)})),baidu.on(this._div,"mousemove",(function(e){ApiUtil.stopBubble(e)})),baidu.on(this._div,"wheel",(function(e){ApiUtil.stopAndPrevent(e)})),baidu.on(this._div,"mousewheel",(function(e){ApiUtil.stopAndPrevent(e)})),baidu.on(window,"resize",(function(){me._adjustDisplayHeight()}))},_adjustDisplayHeight:function(){if(this._indoorInfo){var winHeight,eachBtnHeight=26,heightForDisplay=window.innerHeight-291-100,totalFloors=this._indoorInfo.floors.length,totalControlHeight=26*totalFloors,displayFloors=totalFloors,switchButtonHeight=0;for(this._showArrow=totalControlHeight>heightForDisplay;totalControlHeight>heightForDisplay&&0!==displayFloors;)totalControlHeight=26*--displayFloors+30,switchButtonHeight=30;this._currentDisplayHeight=totalControlHeight,displayFloors<3?this._setAdjustVisbile(!1):this._setAdjustVisbile(!0),this._floorsContainer.style.height=26*displayFloors+"px";for(var currentFloor=this._indoorInfo.currentFloor,j=0;j<this._indoorInfo.floors.length;j++)if(this._indoorInfo.floors[j]===this._indoorInfo.currentFloor){currentFloor=j;break}this._div.style.height=parseInt(this._floorsContainer.style.height,10)+switchButtonHeight+"px";var olTop=26*-(totalFloors-(currentFloor+Math.round(displayFloors/2)));this._setBarSliderTop(olTop),displayFloors<totalFloors?(baidu.show(this._btnTop),baidu.show(this._btnBottom)):(baidu.hide(this._btnTop),baidu.hide(this._btnBottom),this._setBarSliderTop(0))}},_setBarSliderTop:function(top){var totalFloors=this._indoorInfo.floors.length,floorButtonsHeight=26*totalFloors;this._currentDisplayHeight&&(floorButtonsHeight=this._showArrow?this._currentDisplayHeight-30:this._currentDisplayHeight),floorButtonsHeight-top>=26*totalFloors?(top=floorButtonsHeight-26*totalFloors,baidu.ac(this._btnBottom,"disable"),baidu.rc(this._btnBottom,"hover"),this._btnBottom._disable=!0):(baidu.rc(this._btnBottom,"disable"),this._btnBottom._disable=!1),top>=0?(top=0,baidu.ac(this._btnTop,"disable"),baidu.rc(this._btnTop,"hover"),this._btnTop._disable=!0):(baidu.rc(this._btnTop,"disable"),this._btnTop._disable=!1),this._ol.style.top=top+"px"},_setAdjustVisbile:function(visible){this._adjustVisible!==visible&&(this._adjustVisible=visible,visible&&this._visible?this._div.style.right="20px":this._div.style.right="-30px")},setInfo:function(indoorInfo){this._indoorInfo&&this._indoorInfo.uid===indoorInfo.uid||(this._indoorInfo=indoorInfo,this.updateUI())},getInfo:function(){return this._indoorInfo},getFloors:function(){if(this._indoorInfo)return this._indoorInfo.floors},show:function(){!0!==this._visible&&(this._visible=!0,this._div.style.right="20px")},hide:function(){!1!==this._visible&&(this._visible=!1,this._div.style.right="-30px")}};var BaseEvent$1=baidu.lang.Event,DIR_CENTER$1=4,DIR_LEFT$1=3,DIR_TOP$1=2,DIR_RIGHT$1=1,DIR_BOTTOM$1=0,LabelDataParser={parse:function(curViewLabels,labelCtx,tileSize,drawLib,zoomRatio){var map=drawLib._map,indoorMgr=drawLib._indoorMgr,mapZoom=map.getZoom(),zoomUnits=Math.pow(2,18-mapZoom),mercatorProjection,center=indoorMgr.mercatorProjection.lngLatToPoint(map.getCenter()),centerX=center.x,centerY=center.y,mapSize=map.getSize(),mapWidth=mapSize.width,mapHeight=mapSize.height,allLabels=[];for(var tileKey in curViewLabels)if("parsedLabelData"!==tileKey&&mapZoom===curViewLabels[tileKey].tileInfo[2]){var tileLabels=[],tileInfo=curViewLabels[tileKey].tileInfo;tileLabels.x=tileInfo[0],tileLabels.y=tileInfo[1],tileLabels.z=tileInfo[2];for(var tileMCX,tileMCY,tilePixX=(tileInfo[0]*tileSize*zoomUnits-centerX)/zoomUnits+mapWidth/2,tilePixY=(centerY-(tileInfo[1]+1)*tileSize*zoomUnits)/zoomUnits+mapHeight/2,j=0;j<curViewLabels[tileKey].length;j++)curViewLabels[tileKey][j].indoorLabelData&&this.parseLabel(curViewLabels[tileKey][j].indoorLabelData,tileInfo,drawLib,labelCtx,tileSize,tilePixX,tilePixY,mapZoom,zoomUnits,mapWidth,mapHeight,tileLabels,!0,window.indoorStyle);allLabels.push(tileLabels)}if(/collision=0/.test(location.search))for(var computedLabels=[],i=0;i<allLabels.length;i++)for(var j=0;j<allLabels[i].length;j++)computedLabels.push(allLabels[i][j]);else var computedLabels=this.preComputeLabel(allLabels,drawLib._map.getZoom());for(var i=0;i<computedLabels.length;i++){var label=computedLabels[i];if(!label.isDel&&"fixed"===label.type){var drawTextOnIcon=!1;if(label.icon&&label.style&&4===label.direction&&(drawTextOnIcon=!0),label.icon)if(drawTextOnIcon){var me=this;this.drawIcon(labelCtx,label,drawLib,drawTextOnIcon,(function(label){for(var j=0;j<label.textPos.length;j++)me.drawText(labelCtx,label.textPos[j].destX,label.textPos[j].destY,label.textPos[j].text,label.style,drawLib)}))}else this.drawIcon(labelCtx,label,drawLib);if(label.style&&!drawTextOnIcon)for(var j=0;j<label.textPos.length;j++)this.drawText(labelCtx,label.textPos[j].destX,label.textPos[j].destY,label.textPos[j].text,label.style,drawLib)}}return indoorMgr._computedLabels=computedLabels,allLabels},parseLabel:function(poiData,tileInfo,drawLib,labelCtx,tileSize,tilePixX,tilePixY,mapZoom,zoomUnits,mapWidth,mapHeight,tileLabels,isIndoor,fs){var pois=poiData[1];if(pois){var margin=50,ctx=labelCtx,styleZoom=mapZoom;9===styleZoom&&(styleZoom=8);for(var tileMCX=tileInfo[0]*tileSize*zoomUnits,tileMCY=tileInfo[1]*tileSize*zoomUnits,i=0;i<pois.length;i++){var eachStylePois=pois[i],styleId=eachStylePois[0],stylePt=drawLib.getStyleFromCache(styleId,"point",styleZoom,fs),stylePtText=drawLib.getStyleFromCache(styleId,"pointText",styleZoom,fs),poiList=eachStylePois[1];if(poiList){var icon=null,iconZoom=100,iconWidth=0,iconHeight=0;stylePt&&stylePt[0]?(icon=(stylePt=stylePt[0]).icon,iconZoom=stylePt.zoom||100):stylePt=null,stylePtText=stylePtText&&stylePtText[0]?stylePtText[0]:null;for(var j=0;j<poiList.length;j++){var eachPoi=poiList[j][4];if(eachPoi){var tracer=eachPoi[2];if(drawLib.isVisible(tracer,mapZoom)){var mcx=Math.round(eachPoi[0]/100),mcy=Math.round(eachPoi[1]/100),mcPt={lng:tileMCX+mcx,lat:tileMCY+mcy},pxx,pxy,textX=mcx/zoomUnits+tilePixX,textY=tileSize-mcy/zoomUnits+tilePixY;if(isIndoor||!(textX<-50||textY<-50||textX>mapWidth+50||textY>mapHeight+50)){var text=eachPoi[7]||"",labelInfo={type:"fixed",bds:[],pt:mcPt,uid:eachPoi[3]||"",name:text,rank:eachPoi[4],iconPos:null,zoom:styleZoom,textPos:[],originPos:[textX,textY],style:stylePtText,tilePosStr:eachPoi[0]+","+eachPoi[1]};if(null!==icon){var iconInfo=window.iconSetInfo_high[icon];iconInfo||"711"===icon&&(iconInfo=window.iconSetInfo_high._711),iconInfo&&(iconWidth=(iconWidth=iconInfo[2])/2*iconZoom/100,iconHeight=(iconHeight=iconInfo[3])/2*iconZoom/100,labelInfo.iconPos={destX:textX-iconWidth/2,destY:textY-iconHeight/2,width:iconWidth,height:iconHeight},labelInfo.icon=icon)}if(stylePtText){var direction=eachPoi[5];"number"!=typeof direction&&(direction=0);var drawX=0,drawY=0,fontSize,textHeight=stylePtText.fontSize/2,textMargin=.2*textHeight;ctx.font=LabelDataParser.getFontStyle(stylePtText,drawLib);var textArr=text.split("\\"),textRowLength=textArr.length;labelInfo.direction=direction;for(var k=0;k<textRowLength;k++){var textRow=textArr[k],textMetrics,textWidth=ctx.measureText(textRow).width;switch(direction){case 3:var top;drawX=textX-textWidth-iconWidth/2,drawY=(top=textY-textHeight/2*textRowLength-textMargin*(textRowLength-1)/2)+textHeight*k+textMargin*k;break;case 1:var top;drawX=textX+iconWidth/2,drawY=(top=textY-textHeight/2*textRowLength-textMargin*(textRowLength-1)/2)+textHeight*k+textMargin*k;break;case 2:var top;drawX=textX-textWidth/2,drawY=(top=textY-iconHeight/2-textHeight*textRowLength-textMargin*(textRowLength-1)-textMargin)+textHeight*k+textMargin*k;break;case 0:var top;drawX=textX-textWidth/2,drawY=(top=textY+iconHeight/2+textMargin/2)+textHeight*k+textMargin*k;break;case 4:var top;drawX=textX-textWidth/2,drawY=(top=textY-textHeight/2*textRowLength-textMargin*(textRowLength-1)/2)+textHeight*k+textMargin*k}labelInfo.textPos.push({destX:drawX,destY:drawY,width:textWidth,height:textHeight,text:textRow})}}tileLabels.push(labelInfo)}}}}}}}},drawIcon:function(ctx,label,drawLib,drawOnText,callback){var iconName=label.icon;if(LabelDataParser.iconCache[iconName]){var iconImage=LabelDataParser.iconCache[iconName];this.drawIconImage(ctx,label,iconImage,drawOnText,callback)}else{var iconUrl=drawLib.getIconUrl(iconName),img=new Image,me=this;img.onload=function(){LabelDataParser.iconCache[iconName]=this,me.drawIconImage(ctx,label,this,drawOnText,callback),img.onload=null},img.src=iconUrl}},drawIconImage:function(ctx,label,image,drawOnText,callback){var iconPos=label.iconPos,x=iconPos.destX,y=iconPos.destY,iconWidth=null,iconHeight=null,scaleDraw=!0,sid=label.style?label.style.sid:null;if(label.style&&62203===sid){iconWidth=0,iconHeight=0;for(var j=0;j<label.textPos.length;j++)iconWidth<label.textPos[j].width&&(iconWidth=label.textPos[j].width),iconHeight+=20;iconWidth=Math.ceil(iconWidth)+10}drawOnText&&519===sid&&(scaleDraw=!1),null!==iconWidth&&null!==iconHeight?this.drawStretchedIcon(ctx,label,image,8,iconWidth,iconHeight):drawOnText&&scaleDraw?(x-=((iconWidth=Math.ceil(label.textPos[0].width)+6)-image.width/2)/2,this.draw3StretchedIcon(ctx,label,image,12,iconWidth,image.height/2)):ctx.drawImage(image,x,y,iconPos.width,iconPos.height),callback&&callback(label)},drawStretchedIcon:function(ctx,label,img,fixedLength,stretchWidth,stretchHeight){var left=label.originPos[0]-stretchWidth/2,top=label.originPos[1]-stretchHeight/2;navigator.userAgent.indexOf("iPhone")>0&&(top+=1);var drawLength=fixedLength/2;ctx.drawImage(img,0,0,fixedLength,fixedLength,left,top,drawLength,drawLength),ctx.drawImage(img,fixedLength,0,1,fixedLength,left+drawLength,top,stretchWidth-2*drawLength,drawLength),ctx.drawImage(img,img.width-fixedLength,0,fixedLength,fixedLength,left+stretchWidth-drawLength,top,drawLength,drawLength),ctx.drawImage(img,0,fixedLength,fixedLength,1,left,top+drawLength,drawLength,stretchHeight-2*drawLength),ctx.drawImage(img,fixedLength,fixedLength,1,1,left+drawLength,top+drawLength,stretchWidth-2*drawLength,stretchHeight-2*drawLength),ctx.drawImage(img,img.width-fixedLength,fixedLength,fixedLength,1,left+stretchWidth-drawLength,top+drawLength,drawLength,stretchHeight-2*drawLength),ctx.drawImage(img,0,img.height-fixedLength,fixedLength,fixedLength,left,top+stretchHeight-drawLength,drawLength,drawLength),ctx.drawImage(img,fixedLength,img.height-fixedLength,1,fixedLength,left+drawLength,top+stretchHeight-drawLength,stretchWidth-2*drawLength,drawLength),ctx.drawImage(img,img.width-fixedLength,img.height-fixedLength,fixedLength,fixedLength,left+stretchWidth-drawLength,top+stretchHeight-drawLength,drawLength,drawLength)},draw3StretchedIcon:function(ctx,label,img,fixedLength,stretchWidth,stretchHeight){var left=label.originPos[0]-stretchWidth/2,top=label.originPos[1]-stretchHeight/2,drawLength=fixedLength/2;ctx.drawImage(img,0,0,fixedLength,img.height,left,top,drawLength,img.height/2),ctx.drawImage(img,fixedLength,0,1,img.height,left+drawLength,top,stretchWidth-2*drawLength,img.height/2),ctx.drawImage(img,img.width-fixedLength,0,fixedLength,img.height,left+stretchWidth-drawLength,top,drawLength,img.height/2)},drawText:function(ctx,x,y,text,stylePtText,drawLib){ctx.font=LabelDataParser.getFontStyle(stylePtText,drawLib),ctx.fillStyle=stylePtText.fontRgba,stylePtText.haloSize>0&&(ctx.strokeStyle=stylePtText.haloRgba,ctx.strokeText(text,x,y)),ctx.fillText(text,x,y)},getFontStyle:function(style,drawLib){var fontStyle=2===style.fontWeight?"italic":"",fontSize=style.fontSize/2,font=fontStyle;return drawLib.isIphone?(font+=" bold",font+=" "+fontSize+"px",font+=' arial, "PingFang SC", sans-serif'):(font+=" "+fontSize+"px",font+=" arial, sans-serif"),font},preComputeLabel:function(arrLabels,zoom){var arrAll=[],hackMargin=0;5===zoom&&(hackMargin=1),arrLabels.sort((function(a,b){return a.x*a.y<b.x*b.y?-1:1}));for(var i=0,l=arrLabels.length;i<l;i++)for(var arr=arrLabels[i],x=arr.x,y=arr.y,z=arr.z,j=0,ll=arr.length;j<ll;j++){var labelInfo=arr[j],minX=void 0,minY=void 0,maxX=void 0,maxY=void 0;if("fixed"===labelInfo.type){var iconPos=labelInfo.iconPos,textPos=labelInfo.textPos;iconPos&&(minX=iconPos.destX,minY=iconPos.destY,maxX=iconPos.destX+iconPos.width,maxY=iconPos.destY+iconPos.height);for(var k=0;k<textPos.length;k++){var row=textPos[k];void 0!==minX?(row.destX<minX&&(minX=row.destX),row.destY<minY&&(minY=row.destY),row.destX+row.width>maxX&&(maxX=row.destX+row.width),row.destY+row.height>maxY&&(maxY=row.destY+row.height)):(minX=row.destX,minY=row.destY,maxX=row.destX+row.width,maxY=row.destY+row.height)}}else if("line"===labelInfo.type)minX=labelInfo.minX,minY=labelInfo.minY,maxX=labelInfo.maxX,maxY=labelInfo.maxY;else if("biaopai"===labelInfo.type){var pos=labelInfo.pos;minX=pos.destX,minY=pos.destY,maxX=pos.destX+pos.width,maxY=pos.destY+pos.height}void 0!==minX&&(labelInfo.minX=minX,labelInfo.minY=minY,labelInfo.maxX=maxX,labelInfo.maxY=maxY,labelInfo.bds=[minX,minY,maxX,maxY],arrAll.push(labelInfo))}arrAll.sort((function(a,b){return b.rank-a.rank||b.minX-a.minX||b.minY-a.minY}));for(var i=0,l=arrAll.length;i<l;i++){var preLabel=arrAll[i];for(preLabel.isDel=!1,preLabel.arrIntersectIndex=[],j=i+1;j<l;j++){var nextLabel=arrAll[j];preLabel.maxX-hackMargin<nextLabel.minX||preLabel.minX>nextLabel.maxX-hackMargin||preLabel.maxY-hackMargin<nextLabel.minY||preLabel.minY>nextLabel.maxY-hackMargin||preLabel.arrIntersectIndex.push(j)}}for(var i=0,l=arrAll.length;i<l;i++){var label=arrAll[i];if(!1===label.isDel)for(var arrIntersectIndex=label.arrIntersectIndex,j=0,ll=arrIntersectIndex.length;j<ll;j++){var delLabel;arrAll[arrIntersectIndex[j]].isDel=!0}}return arrAll},iconCache:{}};function LabelClick(indoorMgr){this._initVars(indoorMgr),this._initColorCanvas(),this._bindEvent(indoorMgr)}LabelClick.prototype={_initVars:function(indoorMgr){this._map=indoorMgr._map,this._indoorMgr=indoorMgr,this._labelCtx=indoorMgr._labelCtx,this.ratio=this._indoorMgr.ratio,this.sizeRatio=this.ratio>1?2:1,this.RANK1=1e6,this.RANK2=2e6,this.RANK3=3e6,this.RANK4=4e6,this.RANK5=5e6},_initColorCanvas:function(){var colorCvsSize=256,colorCvs=ApiUtil.create("canvas"),colorStyle=colorCvs.style;colorStyle.width="256px",colorStyle.height="256px",colorCvs.width=256,colorCvs.height=256,this._colorCvsSize=256,this._colorCvs=colorCvs,this._colorCtx=colorCvs.getContext("2d")},getLabelImageData:function(label,labelX,labelY){var textPos=label.textPos,ratio=this.ratio,sizeRatio=this.sizeRatio/ratio,colorCtx=this._colorCtx,colorCvsSize=this._colorCvsSize;colorCtx.clearRect(0,0,colorCvsSize,colorCvsSize);for(var style=label.style,fontSize,textHeight=(style={fontSize:label.style.fontSize/sizeRatio,fontRgba:label.style.fontRgba,haloSize:label.style.haloSize,haloRgba:label.style.haloRgba,fontWeight:label.style.fontWeight}).fontSize/2,textMargin=.2*textHeight,totalWidth=textPos[0].width/sizeRatio,totalHeight=0,i=0,l=textPos.length,imgData,oldImgData;i<l;i++){var pos=textPos[i],text=pos.text,destX=(pos.destX-label.minX)/sizeRatio,destY=textHeight*(i+1)+textMargin*i-1/sizeRatio;LabelDataParser.drawText(colorCtx,destX,destY,text,style,this._indoorMgr.vectorDrawLib),pos.width/sizeRatio>totalWidth&&(totalWidth=pos.width/sizeRatio),totalHeight+=(pos.height+textMargin)/sizeRatio}return[colorCtx.getImageData(0,0,totalWidth,totalHeight),colorCtx.getImageData(0,0,totalWidth,totalHeight)]},_bindEvent:function(mgr){var me=this,map=mgr._map;map.addEventListener("onhotspotover",(function(e){if(mgr.temp.isPermitSpotOver&&e.spots[0].tag===mgr.indoorHotspotTarget&&e.spots.length>0){var userData,uid=e.spots[0].getUserData().uid;mgr.temp.curSpots[uid]=e.spots[0];var label=me.findLabelByUid(uid);label&&(label&&me._toHighLightColor(label),e.uid=uid,e.labelInfo=label,me._indoorMgr.config.labelMouseOver(e))}})),map.addEventListener("onhotspotout",(function(e){if(mgr.temp.isPermitSpotOver&&e.spots[0].tag===mgr.indoorHotspotTarget&&e.spots.length>0){var userData,uid=e.spots[0].getUserData().uid;delete mgr.temp.curSpots[uid];var label=me.findLabelByUid(uid);label&&(label&&me._toDefaultColor(label),e.uid=uid,e.labelInfo=label,me._indoorMgr.config.labelMouseOut(e))}})),map.addEventListener("onhotspotclick",(function(e){if(e.spots[0].tag===mgr.indoorHotspotTarget)if(e.spots&&e.spots.length>0){var userData,uid=e.spots[0].getUserData().uid,label=me.findLabelByUid(uid);label&&(label&&me._changeBaseMapState(label),e.uid=uid,e.labelInfo=label,e.point=e.spots[0].getPosition(),me._indoorMgr.config.labelClick(e))}else me._recoverNormalState()})),map.addEventListener("spot_status_reset",(function(){me._recoverNormalState()}))},_getTextBound:function(label){if(!label.textPos||0===label.textPos.length)return null;for(var ratio=this.ratio,sizeRatio=this.sizeRatio/ratio,textPos=label.textPos,baseDrawX=0,baseDrawY=0,minX=0*ratio+(textPos[0].destX-0)/sizeRatio,minY=0*ratio+(textPos[0].destY-0)/sizeRatio,maxX=minX+textPos[0].width/sizeRatio,maxY=minY+textPos[0].height/sizeRatio,i=0,l=textPos.length;i<l;i++){var row=textPos[i],rx=0*ratio+(row.destX-0)/sizeRatio;rx<minX&&(minX=rx);var ry=0*ratio+(row.destY-0)/sizeRatio;ry<minY&&(minY=ry),rx+row.width>maxX&&(maxX=rx+row.width),ry+row.height>maxY&&(maxY=ry+row.height)}return[minX,minY,maxX,maxY]},getFilterImageData:function(imgData,rank){for(var data=imgData.data,i=0,l=data.length;i<l;i+=4){var r=data[i],g=data[i+1],b=data[i+2],a;if(0!==data[i+3]){var m,diff=Math.round((r+g+b)/3)-90;diff=diff<0?0:diff,data[i]=51+1.3*diff,data[i+1]=133+.8*diff,data[i+2]=255}}return imgData},_toHighLightColor:function(label){if(!label._tempRank||label._tempRank!=this.RANK5){var textBound=this._getTextBound(label);if(textBound){var labelX=Math.round(textBound[0]),labelY=Math.round(textBound[1]),arrImageData=this.getLabelImageData(label,labelX,labelY),imgData=arrImageData[0],oldImgData=arrImageData[1],blueColorImgData=this.getFilterImageData(imgData,this.RANK5);label._oldImgData=oldImgData,label._tempRank=this.RANK5,this._labelCtx.putImageData(blueColorImgData,labelX,labelY)}}},_toDefaultColor:function(label){if(label._oldImgData){var ratio=this.sizeRatio,textBound=this._getTextBound(label);if(!textBound)return;label._tempRank=this.RANK1,this._labelCtx.putImageData(label._oldImgData,Math.round(textBound[0]),Math.round(textBound[1])),label._oldImgData=null}},_changeBaseMapState:function(clickLabel){var mgr=this._indoorMgr,guid=clickLabel.uid,guidExt=clickLabel.guidExt},_recoverNormalState:function(){var mgr=this._indoorMgr},findLabelByUid:function(uid){for(var mgr=this._indoorMgr,computedLabel=mgr._computedLabels,i=0,l=computedLabel.length;i<l;i++){var labelInfo=computedLabel[i];if(mgr.isClickableLabel(labelInfo)&&labelInfo.uid==uid)return labelInfo}return null}};var PolyDataParser={drawPoly:function(layer,ctx,zoom,tileSize,lib,fs){var geoObjectSet=layer[1];if(geoObjectSet)for(var precision=layer[6],i=0;i<geoObjectSet.length;i++){var styleId=geoObjectSet[i][0],style=lib.getStyleFromCache(styleId,"polygon",zoom,fs);if(style&&style.length||(style=lib.getStyleFromCache(styleId,"polygon",zoom-1,fs)),style&&style.length)for(var geoObject=geoObjectSet[i][1],j=0;j<geoObject.length;j++){var surface=geoObject[j][1],tracer=surface[0],points;if(lib.isVisible(tracer,zoom))surface["cache"+zoom]||(surface["cache"+zoom]=lib.parseMidPoint(surface[1],zoom,tileSize,precision)),points=surface["cache"+zoom],this.drawSurface(ctx,points,style)}}},drawSurface:function(ctx,points,style){var style0=style[0];ctx.fillStyle=style0.fillRgba,ctx.beginPath(),ctx.moveTo(points[0],points[1]);for(var i=2,l=points.length;i<l;i+=2)ctx.lineTo(points[i],points[i+1]);ctx.closePath(),style0.borderWidth&&(ctx.strokeStyle=style0.borderRgba,ctx.lineWidth=style0.borderWidth/2,ctx.stroke()),ctx.fill()},drawSurfaceBorder:function(ctx,points,style){var style0=style[0];ctx.beginPath(),ctx.moveTo(points[0],points[1]);for(var i=2,l=points.length;i<l;i+=2)ctx.lineTo(points[i],points[i+1]);ctx.closePath(),ctx.strokeStyle=style0.borderRgba,ctx.lineWidth=style0.borderWidth/2,ctx.stroke()},drawSurfaceFill:function(ctx,points,style){var style0=style[0];ctx.fillStyle=style0.fillRgba,ctx.beginPath(),ctx.moveTo(points[0],points[1]);for(var i=2,l=points.length;i<l;i+=2)ctx.lineTo(points[i],points[i+1]);ctx.closePath(),ctx.fill()}},FS=window.FeatureStyle;function IndoorDrawLib(drawLib,indoorMgr){this._drawLib=drawLib,this._indoorMgr=indoorMgr,this._map=drawLib._map,this._indoorData={},this.layerIndex=28}IndoorDrawLib.prototype={parse:function(indoorData,tileInfo,canvasID){var me=this,layerIndex=this.layerIndex;me._indoorData=indoorData;for(var tileKey=canvasID,indoorDataResult={},indoorBase=[],indoorBaseContour=[],i=0;i<indoorData.length;i++){for(var eachIndoorData=indoorData[i][0],eachIndoorInfo=indoorData[i][1],contour=this.parseContour(eachIndoorInfo[2],tileInfo),floorNames=eachIndoorInfo[3].slice(0),defaultFloor=eachIndoorInfo[1],uid=eachIndoorInfo[0],name,eachIndoorDataResult={defaultFloor:defaultFloor,currentFloor:defaultFloor,name:eachIndoorInfo[11],uid:uid,floors:[],contour:contour.contoursCoords,center:contour.center,lnglat:ApiUtil.pointToLngLat(contour.center[0],contour.center[1]),boundsMin:contour.boundsMin,boundsMax:contour.boundsMax,floorLength:floorNames.length,tileKey:tileKey},j=0;j<floorNames.length;j++){var floorName=floorNames[j];eachIndoorDataResult.floors[j]=floorName}indoorDataResult[uid]=eachIndoorDataResult,indoorDataResult.tileInfo=tileInfo}return 0===indoorBase.length&&(indoorBase=null),0===indoorBaseContour.length&&(indoorBaseContour=null),{indoorDataResult:indoorDataResult,indoorBase:indoorBase,indoorBaseContour:indoorBaseContour}},parseContour:function(contour,tileInfo){if(!contour||!contour[0]||!contour[0][1])return{contoursCoords:[],center:[0,0]};for(var contoursCoords=[],center=[0,0],boundsMin=[20037726.37,11028190.87],boundsMax=[-20037726.37,-10601580.79],coordsLen=0,col=tileInfo.col,row=tileInfo.row,mercatorSize=tileInfo.mercatorSize,tileMercatorX=col*mercatorSize,tileMercatorY=row*mercatorSize,i=0;i<contour.length;i++){var coords=contour[i][1],contourCoords=[tileMercatorX+coords[0]/100,tileMercatorY+coords[1]/100];center[0]+=contourCoords[0],center[1]+=contourCoords[1],contourCoords[0]<boundsMin[0]&&(boundsMin[0]=contourCoords[0]),contourCoords[1]<boundsMin[1]&&(boundsMin[1]=contourCoords[1]),contourCoords[0]>boundsMax[0]&&(boundsMax[0]=contourCoords[0]),contourCoords[1]>boundsMax[1]&&(boundsMax[1]=contourCoords[1]);for(var j=2;j<coords.length;j+=2)contourCoords[j]=contourCoords[j-2]+coords[j]/100,contourCoords[j+1]=contourCoords[j-1]+coords[j+1]/100,center[0]+=contourCoords[j],center[1]+=contourCoords[j+1],contourCoords[j]<boundsMin[0]&&(boundsMin[0]=contourCoords[j]),contourCoords[j+1]<boundsMin[1]&&(boundsMin[1]=contourCoords[j+1]),contourCoords[j]>boundsMax[0]&&(boundsMax[0]=contourCoords[j]),contourCoords[j+1]>boundsMax[1]&&(boundsMax[1]=contourCoords[j+1]);coordsLen+=coords.length,contoursCoords.push(contourCoords)}return center[0]/=coordsLen/2,center[1]/=coordsLen/2,{contoursCoords:contoursCoords,center:center,boundsMin:boundsMin,boundsMax:boundsMax}},draw:function(ctx,indoorData,tileInfo,selectOptions){selectOptions=selectOptions||{};for(var tileSize=tileInfo.tileSize,i=0;i<indoorData.length;i++){var eachIndoorFloorData=indoorData[i][0],eachIndoorInfo,uid=indoorData[i][1][0],drawFloorName;drawFloorName="string"==typeof selectOptions.floorName&&selectOptions.indoorUid===uid?selectOptions.floorName:this._indoorMgr._indoorData[uid].currentFloor;var drawData=this.getDataByFloorName(eachIndoorFloorData,drawFloorName);if(drawData)for(var mapZoom=this._map.getZoom(),j=0;j<drawData[3][0].length;j++){var floorData=drawData[3][0][j];floorData&&7===floorData[0]&&PolyDataParser.drawPoly(floorData,ctx,mapZoom,tileSize,this._drawLib,window.indoorStyle)}}},getDataByFloorName:function(floorData,floorName){if("number"==typeof floorName)return floorData[floorName];for(var i=0;i<floorData.length;i++)if(floorData[i][0]===floorName)return floorData[i];return null},getPOIData:function(indoorData,selectOptions){selectOptions=selectOptions||{};for(var allPOIs=[],i=0;i<indoorData.length;i++){var eachIndoorFloorData=indoorData[i][0],eachIndoorInfo,uid=indoorData[i][1][0],drawFloorName;drawFloorName="string"==typeof selectOptions.floorName&&selectOptions.indoorUid===uid?selectOptions.floorName:this._indoorMgr._indoorData[uid].currentFloor;var drawData=this.getDataByFloorName(eachIndoorFloorData,drawFloorName);if(drawData)for(var j=0;j<drawData[3][0].length;j++)3===drawData[3][0][j][0]&&allPOIs.push(drawData[3][0][j])}return allPOIs}};var styleCache={},indoorStyleCache={},binaryCache={},rgbaCache={},FS$1=window.FeatureStyle,indoorStyle=window.indoorStyle,iconSetInfo=window.iconSetInfo_high,iconUrlsConfig=MapConfig.iconUrls,zoomBaseMap={3:{start:3,base:3},4:{start:4,base:5},5:{start:4,base:5},6:{start:6,base:7},7:{start:6,base:7},8:{start:8,base:9},9:{start:8,base:9},10:{start:10,base:10},11:{start:11,base:12},12:{start:11,base:12},13:{start:11,base:12},14:{start:14,base:15},15:{start:14,base:15},16:{start:16,base:17},17:{start:16,base:17},18:{start:18,base:19},19:{start:18,base:19},20:{start:18,base:19},21:{start:18,base:19}};function VectorDrawLib(map,indoorMgr){this._map=map,this._indoorMgr=indoorMgr,this._ratio=indoorMgr.config.devicePixelRatio,this.zoomBaseMap=zoomBaseMap,this.indoorDrawLib=new IndoorDrawLib(this,indoorMgr),this.loadStyle()}VectorDrawLib.prototype={loadStyle:function(){if(!window.indoorStyle){var vctMapFSUpdateDate="20171110",vctMapFSVersion="001";"undefined"!=typeof MSV&&MSV.mapstyle&&(vctMapFSUpdateDate=MSV.mapstyle.updateDate,vctMapFSVersion=MSV.mapstyle.version);var vctMapStyleDomain=MapConfig.vctMapStyleDomain,vctMapFSTimeStamp="udt="+vctMapFSUpdateDate+"&v="+vctMapFSVersion,FeatureStyleUrl,IconMetaUrl=vctMapStyleDomain+"icons_na2x.js?"+vctMapFSTimeStamp,IndoorStyleUrl=vctMapStyleDomain+"indoor_fs.js?"+vctMapFSTimeStamp;DataRequest_request(vctMapStyleDomain+"fs.js?"+vctMapFSTimeStamp),DataRequest_request(IndoorStyleUrl),DataRequest_request(IconMetaUrl)}},drawLabels:function(curViewLabels,iconUrls,labelCtx,tileSize,zoomRatio){iconUrlsConfig||(iconUrlsConfig=iconUrls),curViewLabels.parsedLabelData=LabelDataParser.parse(curViewLabels,labelCtx,tileSize,this,zoomRatio)},getStyleFromCache:function(styleId,type,zoom,fs){var key=styleId+"-"+type+"-"+zoom;return fs?(indoorStyleCache[key]||(indoorStyleCache[key]=this.getStyle(styleId,type,zoom,fs)),indoorStyleCache[key]):(styleCache[key]||(styleCache[key]=this.getStyle(styleId,type,zoom)),styleCache[key])},getStyle:function(styleId,type,zoom,fs){var FS=fs||window.FeatureStyle,style=FS[2];if("arrow"===type)return this.parseArrowStyle(style[2]);switch(type){case"point":style=style[0];break;case"pointText":style=style[1];break;case"line":style=style[3];break;case"polygon":style=style[4];break;case"polygon3d":style=style[5]}var level,result=[],drawId=FS[1][zoom][0][styleId];if(!drawId)return result;for(var i=0;i<drawId.length;i++){var itemStyle=style[drawId[i]];if(itemStyle){switch(type){case"polygon":itemStyle=this.parsePolygonStyle(itemStyle,styleId);break;case"line":itemStyle=this.parseLineStyle(itemStyle,styleId);break;case"pointText":itemStyle=this.parsePointTextStyle(itemStyle,styleId);break;case"point":itemStyle=this.parsePointStyle(itemStyle,styleId);break;case"polygon3d":itemStyle=this.parsePolygon3dStyle(itemStyle,styleId)}result[result.length]=itemStyle}}return result},parsePointTextStyle:function(style,sid){return{sid:sid,fontRgba:this.parseRgba(style[0]),haloRgba:this.parseRgba(style[1]),backRgba:this.parseRgba(style[2]),fontSize:style[3],haloSize:style[4],fontWeight:style[5],fontStyle:style[6],density:style[7]}},parsePointStyle:function(style,sid){return{sid:sid,rank:style[0],ucflag:style[1],icon:style[2],iconType:style[3],nineGG:style[4],density:style[5],zoom:style[6]}},parseLineStyle:function(style,sid){return{sid:sid,borderRgba:this.parseRgba(style[0]),fillRgba:this.parseRgba(style[1]),borderWidth:style[2],fillWidth:style[3],borderCap:style[4],fillCap:style[5],haveBorderLine:style[6],haveBorderTexture:style[7],haveFillTexture:style[8],isUseBorderRgba:style[9],isUseFillRgba:style[10],borderTexture:style[11],fillTexture:style[12],borderTextureType:style[13],fillTextureType:style[14],isRealWidth:style[15],haveArrow:style[16],needRound:style[17],realBorderWidth:style[18]}},parsePolygonStyle:function(style,sid){return{sid:sid,fillRgba:this.parseRgba(style[0]),borderRgba:this.parseRgba(style[1]),borderWidth:style[2],borderTexture:style[3],borderTextureType:style[4],waterStyle:style[5],haloStyle:style[6],textureStyle:style[7],thickRgba:this.parseRgba(style[8])}},parseArrowStyle:function(style){for(var key in style){var arrowStyle=style[key];return{color:this.parseRgba(arrowStyle[0]),iconType:arrowStyle[1],icon:arrowStyle[2]}}},parseRgba:function(nColor){var orig=nColor;if(rgbaCache[orig])return rgbaCache[orig];var r=255&(nColor>>>=0),g=nColor>>8&255,b=nColor>>16&255,a=(nColor>>24&255)/255;return rgbaCache[orig]="rgba("+r+","+g+","+b+","+a+")",rgbaCache[orig]},isVisible:function(tracer,zoom){var binary,start;return binaryCache[tracer]||((binary=tracer.toString(2)).length<8&&(binary=new Array(8-binary.length+1).join("0")+binary),binaryCache[tracer]=binary),"1"===(binary=binaryCache[tracer])[zoom-zoomBaseMap[zoom].start]},getStartZoom:function(tracer,zoom){var binary;binaryCache[tracer]||((binary=tracer.toString(2)).length<8&&(binary=new Array(8-binary.length+1).join("0")+binary),binaryCache[tracer]=binary),binary=binaryCache[tracer];for(var start=zoomBaseMap[zoom].start,end,zoomSpan=zoomBaseMap[zoom].end-start+1,i=0;i<zoomSpan;i++)if("1"===binary[i])return i+start;return 99},getIconVertexData:function(iconName,iconZoom){if(!(iconSetInfo=window.iconSetInfo_high))return this.getIconVertexData(iconName,iconZoom);var iconInfo=iconSetInfo[iconName],ratio=2;if(iconInfo||iconName.charCodeAt(0)>=48&&iconName.charCodeAt(0)<=57&&(iconInfo=iconSetInfo["_"+iconName]),iconInfo){var iconWidth=iconInfo[0]/2*iconZoom,iconHeight=iconInfo[1]/2*iconZoom,x0=Math.round(-iconWidth/2),y0=Math.round(-iconHeight/2),x1=x0+iconWidth,y1=y0,x2=x1,y2=y0+iconHeight,x3,y3;return{vertex:[x0,y0,x1,y0,x1,y2,x0,y0,x1,y2,x0,y2],texcoord:null,width:iconWidth,height:iconHeight,iconType:iconName}}return null},addBounds:function(labelInfo){var minX=1e3,minY=1e3,maxX=-1e3,maxY=-1e3;if(labelInfo.iconPos&&labelInfo.iconPos.vertex)for(var iconVertex=labelInfo.iconPos.vertex,i=0,l=iconVertex.length;i<l;i+=2){var x,y;(x=iconVertex[i])<minX&&(minX=x),x>maxX&&(maxX=x),(y=iconVertex[i+1])<minY&&(minY=y),y>maxY&&(maxY=y)}if(labelInfo.textPos&&labelInfo.textPos.vertex)for(var textVertex=labelInfo.textPos.vertex,i=0,l=textVertex.length;i<l;i+=2){var x,y;(x=textVertex[i])<minX&&(minX=x),x>maxX&&(maxX=x),(y=textVertex[i+1])<minY&&(minY=y),y>maxY&&(maxY=y)}labelInfo.bds=[minX,minY,maxX,maxY]},getTextVertexData:function(eachPoi,iconWidth,iconHeight,textImgWidth,textImgHeight){var direction=eachPoi[5],ratio=textSizeRatio;"number"!=typeof direction&&(direction=DIR_BOTTOM);for(var positions=eachPoi[12],textRowLength=positions.length,arrVertex=[],arrSt=[],accHeight=0,totalHeight=0,k=0;k<textRowLength;k++)totalHeight+=Math.round(positions[k][3]/ratio);for(var k=0;k<textRowLength;k++){var pos=positions[k],textLeft=pos[0],textTop=pos[1],textWidth=Math.round(pos[2]/ratio),textHeight=Math.round(pos[3]/ratio),textMargin=2,textIconMargin=2,x0,y0;switch(0===iconWidth&&(direction=DIR_CENTER),direction){case DIR_LEFT:var bottom=totalHeight/2-textHeight+2*(textRowLength-1)/2;x0=Math.round(-iconWidth/2-textWidth-2),y0=Math.round(bottom-accHeight-2*k);break;case DIR_RIGHT:var bottom=totalHeight/2-textHeight+2*(textRowLength-1)/2;x0=Math.round(iconWidth/2+2),y0=Math.round(bottom-accHeight-2*k);break;case DIR_TOP:var bottom=iconHeight/2+totalHeight-textHeight+2*textRowLength;x0=Math.round(-textWidth/2),y0=Math.round(bottom-accHeight-2*k);break;case DIR_BOTTOM:var bottom=-iconHeight/2-2-textHeight;x0=Math.round(-textWidth/2),y0=Math.round(bottom-accHeight-2*k);break;case DIR_CENTER:var bottom=-totalHeight/2-2*(textRowLength-1)/2;x0=Math.round(-textWidth/2),y0=Math.round(bottom-accHeight-2*k)}accHeight+=textHeight;var x1=x0+Math.round(textWidth),y1=y0,x2=x1,y2=y1+Math.round(textHeight),x3=x0,y3=y2,s0=textLeft/textImgWidth,t0=(textImgHeight-textTop-textHeight*ratio)/textImgHeight,s1=(textLeft+textWidth*ratio)/textImgWidth,t1=t0,s2=s1,t2=(textImgHeight-textTop)/textImgHeight,s3=s0,t3=t2;arrVertex.push(x0,y0,x1,y1,x2,y2,x0,y0,x2,y2,x3,y3),arrSt.push(s0,t0,s1,t1,s2,t2,s0,t0,s2,t2,s3,t3)}return{vertex:arrVertex,texcoord:arrSt}},parseMidPoint:function(orig,zoom,tileSize){var result=[],base=zoomBaseMap[zoom].base,scale=Math.pow(2,zoom-base)/100,x=orig[0]*scale,y=orig[1]*scale;result[result.length]=x,result[result.length]=tileSize-y;for(var i=2;i<orig.length;i+=2)x+=orig[i]*scale,y+=orig[i+1]*scale,result[result.length]=x,result[result.length]=tileSize-y;return result},getIconUrl:function(iconName){var rndNum=iconName.length%iconUrlsConfig.length,versionInfo=this.getIconVersionInfo(),ver=versionInfo.ver,udt=versionInfo.udt;return iconUrlsConfig[rndNum]+iconName+".png?v="+ver+"&udt="+udt},getIconVersionInfo:function(){if(this.iconVersionInfo)return this.iconVersionInfo;var vectorVer="undefined"!=typeof MSV?MSV.mapstyle:{},ver=vectorVer.version?vectorVer.version:"001",udt=vectorVer.updateDate?vectorVer.updateDate:"20150621";return this.iconVersionInfo={ver:ver,udt:udt},this.iconVersionInfo}};var BaseEvent$2=baidu.lang.Event,MAP_SEARCH_INVALID_REQUEST_SUCCESS=0;function IndoorManager(map,opts){var me=this;me.authentic_key=null,me._map=map,me.initMinZoom=17,me.initMaxZoom=21,me.mobileInitMaxZoom=20,me.getPoiInfoOptions={onRequestComplete:function(e){},onRequestSuccess:function(e){},onRequestError:function(e){}},me.config={tileTypeName:"na",devicePixelRatio:window.devicePixelRatio||2,buildingId:null,floor:null,minZoom:me.initMinZoom,maxZoom:me.initMaxZoom,enableIndoor:!0,showBaseMap:!0,showIndoorControl:!0,showLabel:!0,autoShowIndoorControl:!0,complete:function(e){},beforeChangeFloor:function(e){},afterChangeFloor:function(e){},indoorClick:function(e){},labelClick:function(e){},labelMouseOver:function(e){},labelMouseOut:function(e){},getPoiInfoOptions:me.getPoiInfoOptions},opts=opts||{},baidu.extend(me.config,opts),me.vectorDrawLib={},me.indoorDrawLib={},me._tileCache={},me._indoorData={},me._tileCanvas={},me.currentUid=null,me.currentFloor=null,me._indoorControl=null,me.curViewLabels={},me._computedLabels=[],me.labelCanvas=null,me.labelCtx=null,me._labelClick=new LabelClick(this),me.enterMethod=null,me.ratio=null,me.scaler=1,me.areaSpots={},me.indoorHotspotTarget="INDOOR_SPOT_INFO",me.temp={spotsGuid:1,curAreaSpot:null,curSpots:{},isRequestPoiByUid:!1,indoorId:me.config.buildingId,indoorFloor:me.config.floor,isPermitSpotOver:!0},me.mapType=map.getMapType(),me._tileType=TileType.getInstance(this.config.tileTypeName),me.mercatorProjection=me.mapType.getProjection(),me.isDrawText=!1,me._indoorAddres={},me.callbackNum=1,me._init()}IndoorManager.prototype={_init:function(){var me=this,map=me._map;me.authentic_key=map.getKey(),me.authentic_key&&(me._checkZoom(),BMAP_NORMAL_MAP.setMaxZoom(me.config.maxZoom),map.setMaxZoom(me.config.maxZoom),me._map.highResolutionEnabled()&&(me.scaler=2),me.vectorDrawLib=new VectorDrawLib(map,me),me.indoorDrawLib=me.vectorDrawLib.indoorDrawLib,me._bind(),setTimeout((function(){map.initIndoorLayer({tileUrls:MapConfig.tileUrls,urlOpts:{styles:"pl",extdata:1,textimg:0,mesh3d:0},maxZoom:me.config.maxZoom}),me.config.buildingId&&me.setIndoor(me.config.buildingId,me.config.floor)}),1e3))},_bind:function(){var me=this,map=me._map;function checkAreaSpot(indoorMgr,point){if(point){for(var id in indoorMgr.areaSpots){var spot=indoorMgr.areaSpots[id];if(ApiUtil.pointInPolygon([point.x,point.y],spot.spot))return id}return null}}map.addEventListener("updateindoor",(function(e){var indoorCanvas=e.IndoorCanvas[0],data=indoorCanvas.data;if(me.config.enableIndoor&&me._map.getZoom()>=me.config.minZoom&&void 0!==data&&void 0!==data[1]){var canvasID=indoorCanvas.canvasID;me.setTileCache(canvasID,indoorCanvas);var canvasDom=indoorCanvas.canvasDom,ctx=canvasDom.getContext("2d");me.ratio=indoorCanvas.ratio;var canvasKeys=canvasID.split("_"),col=parseInt(canvasKeys[2],0),row=parseInt(canvasKeys[3],0),useZoom=parseInt(canvasKeys[4],0),zoom=parseInt(canvasKeys[5],0),tileSize=me._tileType.getTileSize(zoom),mercatorSize,tileInfo={baseTileSize:1024,col:col,loopOffsetX:0,mercatorSize:me._tileType.getMercatorSize(zoom),row:row,tileSize:tileSize,tileTypeName:me.config.tileTypeName,useZoom:useZoom,ratio:me.ratio,zoom:zoom};me._tileCache[canvasID].tileInfo=tileInfo,me._tileCanvas[canvasID]=canvasDom;var indoorData=me.indoorDrawLib.parse(data[1],tileInfo,canvasID);me.setData(indoorData),me.setCurViewLabels(data[1],tileInfo),me.drawIndoor(ctx,data[1],tileInfo)}})),map.addEventListener("updateindoorlabel",(function(e){me.labelCanvas=e.labelCanvasDom,me.labelCtx=me.labelCanvas.getContext("2d"),me._labelClick.ratio=me.ratio,me._labelClick._labelCtx=me.labelCtx,me.updateLabel(),delete e.labelCanvasDom,e.type="onindoorcomplete",me.config.complete(e)})),map.addEventListener("indoor_status_changed",(function(e){var uid=e.uid,floor=e.floor;if(me.temp.indoorId&&me.temp.indoorId===uid&&(me.temp.indoorId=null,me.temp.indoorFloor=null),me.config.showBaseMap?me.showBaseMap():me.hideBaseMap(),null===uid)uid=me.currentUid,me._indoorData[uid]&&(floor=me._indoorData[uid].defaultFloor),me._indoorControl&&me._indoorControl.hide(),me.currentUid=null,me.enterMethod=null;else if(me._indoorData[uid]){var indoorData=me._indoorData[uid];me.config.showIndoorControl&&(me._indoorControl?(me._indoorControl.setInfo(indoorData),me._indoorControl.show()):(indoorData.currentFloor=floor,me._indoorControl=new IndoorControl(map,me,indoorData))),me.currentUid=uid,me.currentFloor=floor}if("byClick"===me.enterMethod&&me._map.closeInfoWindow(),me._indoorData&&me._indoorData[uid]&&me._indoorData[uid].currentFloor!==floor){if(indoorData){e.currentFloor=me._indoorData[uid].currentFloor,e.type="onbefore_change_floor",me.config.beforeChangeFloor(e),me._indoorData[uid].currentFloor=floor;for(var tileKeys=indoorData.tileKeys,mapZoom=me._map.getZoom(),dataZoom=me._tileType.getDataZoom(mapZoom),j=0;j<tileKeys.length;j++){var tks=tileKeys[j].split("_");if(parseInt(tks[4],10)===dataZoom&&parseInt(tks[5],10)===mapZoom){var event=new BaseEvent$2("onindoor_data_refresh");event.uid=uid,event.floor=floor,event.tileKey=tileKeys[j],me._map.dispatchEvent(event)}}me.updateLabel(),e.currentFloor=me._indoorData[uid].currentFloor,e.type="onafter_change_floor",me.config.afterChangeFloor(e)}}else me._map.dispatchEvent(new BaseEvent$2("onrefresh"))})),map.addEventListener("moveend",(function(e){"centerAndZoom"!==e._eventSrc&&me.config.enableIndoor&&me._map.getZoom()>=me.config.minZoom&&me._checkIndoorByMove()})),map.addEventListener("zoomend",(function(e){"centerAndZoom"!==e._eventSrc&&(me._map.closeInfoWindow(),me.config.enableIndoor&&me._map.getZoom()>=me.config.minZoom?me._checkIndoorByMove():"byClick"!==me.enterMethod&&null!==me.currentUid&&(me.showIndoor(null),me._checkIndoorByMove()))})),map.addEventListener("centerandzoom",(function(){me.config.enableIndoor&&me._map.getZoom()>=me.config.minZoom?me._checkIndoorByMove():"byClick"!==me.enterMethod&&null!==me.currentUid&&(me.showIndoor(null),me._checkIndoorByMove())})),map.addEventListener("indoor_data_refresh",(function(e){var indoorCanvas=me.getTileCache(e.tileKey);if(indoorCanvas){var data=indoorCanvas.data,canvasDom,ctx=indoorCanvas.canvasDom.getContext("2d"),tileInfo=indoorCanvas.tileInfo;me.setCurViewLabels(data[1],tileInfo),me.drawIndoor(ctx,data[1],tileInfo)}})),map.addEventListener("click",(function(e){var t=me.temp;if((!e.overlay||e.overlay instanceof BMap.Polygon)&&e.point){t.curAreaSpot=null;var spotevent=new BaseEvent$2("onareaspotclick");spotevent.point=e.point,spotevent.pixel=e.pixel,spotevent.spots=t.curSpots;var spots=spotevent.spots||{};for(var uid in spots){var iconPoint=spots[uid].getPosition(),mercatorPoint=me.mercatorProjection.lngLatToPoint(iconPoint),areaId;(areaId=checkAreaSpot(me,mercatorPoint))&&(t.curAreaSpot=areaId)}if(null===t.curAreaSpot){var clickPoint=spotevent.point,mercatorPoint=me.mercatorProjection.lngLatToPoint(clickPoint),areaId;(areaId=checkAreaSpot(me,mercatorPoint))&&(t.curAreaSpot=areaId)}spotevent.curAreaSpot=t.curAreaSpot,me.enterMethod="byClick",this.dispatchEvent(spotevent)}})),map.addEventListener("areaspotclick",(function(e){var clickIndoorUid=null;if(e.curAreaSpot&&me.areaSpots[e.curAreaSpot]&&(clickIndoorUid=me.areaSpots[e.curAreaSpot].userData.uid),clickIndoorUid===me.currentUid)return e.curAreaSpot&&(me.enterMethod="byClick"),void me.config.indoorClick(e);null===clickIndoorUid?me.currentUid&&"byClick"===me.enterMethod&&(me.currentUid=null,me.currentFloor=null,me.enterMethod=null,me._indoorControl.hide()):(me.enterMethod="byClick",me.showIndoor(clickIndoorUid,me._indoorData[clickIndoorUid].currentFloor),me.config.indoorClick(e))}))},enableIndoor:function(){this.config.enableIndoor=!0,this.config.maxZoom>19&&BMAP_NORMAL_MAP.setMaxZoom(this.config.maxZoom),baidu.show(this.labelCanvas.parentElement),this._map.panTo(this._map.getCenter()),this.showLabels(),this.showIndoorControl()},disableIndoor:function(){this.config.enableIndoor=!1,this.config.maxZoom>19&&BMAP_NORMAL_MAP.setMaxZoom(19),baidu.hide(this.labelCanvas.parentElement),this.hideLabels(),this.hideIndoorControl()},getBuildingId:function(){return this.currentUid},setBuildingId:function(buildingId,opts){var me=this;opts=opts||{},baidu.extend(me.config.getPoiInfoOptions,opts),me.temp.isRequestPoiByUid=!0,me.getPoiInfoByUid(buildingId,me.config.getPoiInfoOptions)},getAllFloors:function(uid){var me=this,floors;return uid=uid||me.currentUid,me._indoorData[uid]&&me._indoorData[uid].floors},getFloor:function(){return this.currentFloor},setFloor:function(floor){this.currentUid&&this.setIndoor(this.currentUid,floor)},getMinZoom:function(){return this.config.minZoom},setMinZoom:function(minZoom){this.config.minZoom=minZoom,this._checkZoom()},getMaxZoom:function(){return this.config.maxZoom},setMaxZoom:function(maxZoom){this.config.maxZoom=maxZoom,this._checkZoom(),BMAP_NORMAL_MAP.setMaxZoom(this.config.maxZoom),this._map.setMaxZoom(this.config.maxZoom)},setOptions:function(opts){var me=this,uid=opts.buildingId,floor=opts.floor,maxZoom=opts.maxZoom,minZoom=opts.minZoom;maxZoom&&maxZoom!==me.getMaxZoom&&me.setMaxZoom(maxZoom),minZoom&&minZoom!==me.getMinZoom&&me.setMinZoom(minZoom),opts=opts||{},baidu.extend(me.config,opts),uid?me.setIndoor(uid,floor,opts):me.showIndoor(me.currentUid,me.currentFloor)},showBaseMap:function(){this.config.showBaseMap=!0,this._map.setNormalMapDisplay(!0)},hideBaseMap:function(){this.config.showBaseMap=!1,this._map.setNormalMapDisplay(!1)},setIndoor:function(uid,floor,opts){var me=this;if(me._indoorData[uid]){opts=opts||{},baidu.extend(me.config,opts);var indoorData=me._indoorData[uid],lnglat=indoorData.lnglat,point=new BMap.Point(lnglat[0],lnglat[1]),name=indoorData.name;me._map.panTo(point),me.currentUid=uid,me.showIndoor(uid,floor);var result={status:0,info:{uid:uid,center:point,address:me._indoorAddres[uid],name:name}};me.config.getPoiInfoOptions.onRequestSuccess(result),me.config.getPoiInfoOptions.onRequestComplete(result)}else me.temp.indoorId=uid,me.temp.indoorFloor=floor,me.setBuildingId(uid,opts)},showIndoorControl:function(){this.config.showIndoorControl=!0,this._indoorControl&&this._indoorControl.show()},hideIndoorControl:function(){this.config.showIndoorControl=!1,this._indoorControl&&this._indoorControl.hide()},showLabels:function(){this.config.showLabel=!0,this.updateLabel()},hideLabels:function(){this.config.showLabel=!1,this.updateLabel()},getPoiInfoByUid:function(uid,opts){var me=this;opts=opts||{},baidu.extend(me.config.getPoiInfoOptions,opts);var cbkName="cbk_indoor_"+me.callbackNum++,url=MapConfig.poiUrl+"&ak="+me.authentic_key+"&uid="+uid+"&callback=BMap."+cbkName,result={status:0,info:null};BMap[cbkName]=function(data){if(result.status=data.uii_err,0===data.uii_err){var content=data.content;me._indoorAddres[uid]=content.addr;var info={uid:content.uid,name:content.name,address:content.addr,center:""};if(content&&content.diPointX&&content.diPointY){var mercatorCenter=new BMap.Pixel(content.diPointX/100,content.diPointY/100);info.center=me.mercatorProjection.pointToLngLat(mercatorCenter)}else me.config.getPoiInfoOptions.onRequestError(result);result.info=info,me.temp.isRequestPoiByUid&&(me._map.panTo(info.center),me.temp.isRequestPoiByUid=!1),me.config.getPoiInfoOptions.onRequestSuccess(result)}else me.config.getPoiInfoOptions.onRequestError(result);me.config.getPoiInfoOptions.onRequestComplete(result),delete BMap[cbkName]};var requestOpts={loadedCbk:BMap[cbkName]};DataRequest_request(url,requestOpts)},setCurViewLabels:function(data,tileInfo){var me=this,tileLabel=[],arrLabelInfo=[];arrLabelInfo.x=tileInfo.col,arrLabelInfo.y=tileInfo.row,arrLabelInfo.z=tileInfo.zoom,tileLabel.tileInfo=[tileInfo.col,tileInfo.row,tileInfo.zoom];var tileKey=tileInfo.col+"_"+tileInfo.row+"_"+tileInfo.zoom;if(me.config.enableIndoor&&data&&me._map.getZoom()>=me.config.minZoom)for(var indoorPoi=me.indoorDrawLib.getPOIData(data,{indoorUid:me.currentUid,floorName:me.currentFloor}),i=0;i<indoorPoi.length;i++)tileLabel.push({indoorLabelData:indoorPoi[i]});me.curViewLabels[tileKey]=tileLabel},updateLabel:function(){if(!this.config.enableIndoor||!this.config.showLabel||this._map.getZoom()<this.config.minZoom||this._map.getZoom()>this.config.maxZoom)return this.clearLabel(),void this.clearSpots();if(this.labelCanvas){var st=(new Date).getTime(),map=this._map;this.labelCanvas.style.left=-map.offsetX+"px",this.labelCanvas.style.top=-map.offsetY+"px",this.clearLabel();var tileType=this._tileType,mapZoom=map.getZoom(),dataZoom=tileType.getDataZoom(map.getZoom()),zoomRatio=Math.pow(2,mapZoom-dataZoom);this.vectorDrawLib.drawLabels(this.curViewLabels,MapConfig.iconUrls,this.labelCtx,tileType.getTileSize(mapZoom),zoomRatio),this.addSpotData(),this.temp.isPermitSpotOver=!0,this.curViewLabels.length>0&&(this.isDrawText=!0)}},clearLabel:function(){var map,mapSize=this._map.getSize(),mapWidth=mapSize.width,mapHeight=mapSize.height,ratio=this.ratio;this.labelCtx&&this.labelCtx.clearRect(0,0,mapWidth*ratio,mapHeight*ratio)},_checkZoom:function(){baidu.isMobile&&(this.initMaxZoom=this.mobileInitMaxZoom);var mapTypeMinZoom=this.initMinZoom,mapTypeMaxZoom=this.initMaxZoom,config=this.config;config.minZoom<mapTypeMinZoom&&(config.minZoom=mapTypeMinZoom),config.maxZoom>mapTypeMaxZoom&&(config.maxZoom=mapTypeMaxZoom)},_checkIndoorByMove:function(){var me=this,map=me._map,mapSize=map.getSize(),screenCenter={x:mapSize.width/2,y:mapSize.height/2},minDistance=Math.max(mapSize.width,mapSize.height),result=[];for(var uid in me._indoorData){var indoorCenterScreen=map.pointToPixel({lng:me._indoorData[uid].lnglat[0],lat:me._indoorData[uid].lnglat[1]}),distanceToCenter=ApiUtil.getDistanceByPixel(screenCenter,indoorCenterScreen);result.push({uid:uid,distance:distanceToCenter})}if(0!==result.length){result.sort((function(a,b){return a.distance-b.distance}));for(var firstResult=result[0],mapCenter=map.getCenter(),mapCenterMercator=me.mercatorProjection.lngLatToPoint(mapCenter),ifPointInIndoorArea=!1,i=0;i<me._indoorData[firstResult.uid].contour.length;i++)if(ApiUtil.pointInPolygon([mapCenterMercator.x,mapCenterMercator.y],me._indoorData[firstResult.uid].contour[i])){ifPointInIndoorArea=!0;break}if(!1===ifPointInIndoorArea&&"e96b44200baa3b4082288acc"===firstResult.uid){var boundsMin=me._indoorData[firstResult.uid].boundsMin,boundsMax=me._indoorData[firstResult.uid].boundsMax;mapCenterMercator.x>boundsMin[0]&&mapCenterMercator.y>boundsMin[1]&&mapCenterMercator.x<boundsMax[0]&&mapCenterMercator.y<boundsMax[1]&&(ifPointInIndoorArea=!0)}ifPointInIndoorArea?me.config.autoShowIndoorControl&&"byClick"!==me.enterMethod&&(null!==me.currentUid&&me.currentUid!==firstResult.uid&&me.showIndoor(me.currentUid,me.currentFloor),me.currentUid!==firstResult.uid&&(firstResult.uid===me.temp.indoorId?me.showIndoor(me.temp.indoorId,me.temp.indoorFloor):me.showIndoor(firstResult.uid,me._indoorData[firstResult.uid].currentFloor)),me.enterMethod="byMove"):"byClick"!==me.enterMethod&&me.showIndoor(null)}},drawIndoor:function(ctx,vtd,tileInfo){var me=this;if(window.FeatureStyle&&window.iconSetInfo_high){var tileCanvas=ctx.canvas,ratio=me.ratio,tileSize=tileInfo.tileSize;ratio>1&&!tileCanvas._scale&&(ctx.scale(ratio,ratio),tileCanvas._scale=!0),ctx.clearRect(0,0,tileSize,tileSize),me.indoorDrawLib.draw(ctx,vtd,tileInfo,{indoorUid:me.currentUid,floorName:me.currentFloor}),ctx.canvas._drawFinished=!0}else me.vectorDrawLib.loadStyle(),setTimeout((function(){me.drawIndoor(ctx,vtd,tileInfo)}),10)},setData:function(data){var me=this;if(null!==data){var data=data.indoorDataResult;for(var uid in data)if("tileInfo"!==uid){var tileKey=data[uid].tileKey;if(me._indoorData[uid])me._indoorData[uid][tileKey]||(me._indoorData[uid].tileKeys.push(tileKey),me._indoorData[uid][tileKey]=!0);else{me._indoorData[uid]=data[uid],me._indoorData[uid].tileKeys=[data[uid].tileKey],me._indoorData[uid][tileKey]=!0;for(var i=0;i<me._indoorData[uid].contour.length;i++)me.addAreaSpot(me._indoorData[uid].contour[i],{id:uid+i,userData:{uid:uid}})}}me.config.enableIndoor&&me._map.getZoom()>=me.config.minZoom&&me._checkIndoorByMove()}},removeData:function(uid,tileKey){if(this._indoorData[uid]){for(var indoorData=this._indoorData[uid],i=0;i<indoorData.tileKeys.length;i++)if(indoorData.tileKeys[i]===tileKey){indoorData.tileKeys.splice(i,1);break}delete indoorData[tileKey],0===indoorData.tileKeys.length&&delete this._indoorData[uid]}},getTileCache:function(tileKey){return this._tileCache[tileKey]},setTileCache:function(tileKey,indoorRawData){this._tileCache[tileKey]||(this._tileCache[tileKey]=indoorRawData)},showIndoor:function(uid,floor){this._indoorData[uid]&&!floor&&(floor=this._indoorData[uid].defaultFloor);var event=new BaseEvent$2("onindoor_status_changed");event.uid=uid,event.floor=floor,this._map.dispatchEvent(event)},addAreaSpot:function(areaSpot,opts){if(areaSpot&&0!==areaSpot.length){opts=opts||{},this.areaSpots=this.areaSpots||{};var nguid=opts.id||"sp"+this.temp.spotsGuid++;return this.areaSpots[nguid]={spot:areaSpot,userData:opts.userData},nguid}},getAreaSpot:function(id){return this.areaSpots&&this.areaSpots[id]?this.areaSpots[id]:null},removeAreaSpot:function(id){id&&this.areaSpots[id]&&delete this.areaSpots[id]},clearAreaSpots:function(){this.areaSpots={}},addSpotData:function(){var me=this;this._spotData=[],this.clearSpots();for(var zoom=this._map.getZoom(),i=0,l=this._computedLabels.length;i<l;i++){var labelInfo=this._computedLabels[i];if(this.isClickableLabel(labelInfo)){var bd=labelInfo.bds,center=null,offsets=[9,9,9,9];if(labelInfo.pt){var mercatorCenter=new BMap.Pixel(labelInfo.pt.lng,labelInfo.pt.lat),center=me.mercatorProjection.pointToLngLat(mercatorCenter),pixel=me._map.pointToPixel(center),offsets;(offsets=[])[0]=pixel.y-bd[1],offsets[1]=bd[2]-pixel.x,offsets[2]=bd[3]-pixel.y,offsets[3]=pixel.x-bd[0]}var name=labelInfo.name,spot={n:name,pt:center,userdata:{iconPoint:center,uid:labelInfo.uid,name:name,type:labelInfo.icon,iconImg:labelInfo.iconImg,zoom:labelInfo.zoom,adver_log:labelInfo.adver_log||""},offsets:offsets,bd:bd,tag:"INDOOR_SPOT_INFO"},hotspot=new BMap.Hotspot(center,{userData:spot.userdata,offsets:spot.offsets});me._map.addHotspot(hotspot,spot.tag),this._spotData.push(spot)}}},clearSpots:function(){this._map.clearHotspots(this.indoorHotspotTarget)},isClickableLabel:function(labelInfo){return!labelInfo.isDel&&"line"!==labelInfo.type&&"0"!==labelInfo.uid}},exports.version="1.0.1",exports.IndoorManager=IndoorManager,Object.defineProperty(exports,"__esModule",{value:!0})}));